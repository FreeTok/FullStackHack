<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script src="./assets/aframe.min.js"></script>
    <script src="./assets/mindar-image-aframe.prod.js"></script>
    <script src="./assets/aframe-extras.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;600;700&display=swap');

        :root {
            --primary-color: #d9a05c; /* A warm, vintage orange/brown */
            --secondary-color: #5c85d9; /* A muted blue */
            --accent-color: #f2e8c9; /* A creamy, paper-like color */
            --text-color: #4a3f35; /* Dark brown for text */
            --white-color: #f7f5f2;
            --success-color: #7aa35b; /* A gentle green */
            --disabled-color: #9e9e9e;
        }

        * {
            margin: 0; padding: 0; box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Comfortaa', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            overflow: hidden; position: fixed; width: 100%; height: 100%; 
            background-color: var(--accent-color);
        }

        /* –°—Ç–∞—Ä—Ç–æ–≤–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .intro-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            z-index: 6000; display: flex; align-items: center; justify-content: center;
            padding: 20px;
        }
                
        .intro-modal.hidden { display: none; }
        
        .intro-content {
            background: var(--accent-color);
            border: 6px solid var(--primary-color);
            border-radius: 20px; 
            padding: 35px 25px;
            max-width: 450px; 
            width: 100%; 
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
                                
        .intro-content h1 {
            font-size: 28px; 
            color: var(--primary-color); 
            margin-bottom: 20px;
            font-weight: 700;
            letter-spacing: 1px;
        }
        
        .intro-content .story {
            font-size: 15px; 
            line-height: 1.7; 
            color: var(--text-color);
            margin-bottom: 25px; 
            text-align: left;
            background: rgba(217, 160, 92, 0.1);
            padding: 15px;
            border-radius: 15px;
            border-left: 4px solid var(--primary-color);
        }
        
        .intro-content .story p strong {
            color: var(--primary-color);
        }
        
        .intro-content .characters-preview {
            display: flex; 
            justify-content: center; 
            gap: 10px;
            margin: 25px 0; 
            flex-wrap: wrap;
        }
        
        .character-icon-preview {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.5);
            border: 3px solid var(--primary-color);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .character-icon-preview img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
                
        .start-quest-btn {
            background-color: var(--primary-color);
            color: var(--white-color); 
            border: none;
            border-radius: 50px;
            padding: 18px 45px; 
            font-size: 19px; 
            font-weight: 700;
            cursor: pointer; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: all 0.2s;
            letter-spacing: 1px;
        }
        
        .start-quest-btn:active { 
            transform: scale(0.95) translateY(2px); 
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ */
        .progress-bar {
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            z-index: 1000;
            /* –£–±—Ä–∞–Ω —Ñ–æ–Ω, –∫–∞–∫ –∏ –ø—Ä–æ—Å–∏–ª–∏ */
            background: none; 
            padding: max(env(safe-area-inset-top), 12px) 10px 12px 10px;
            display: flex; 
            justify-content: space-around; 
            align-items: center;
            pointer-events: auto;
        }
        
        .character-progress {
            display: flex; 
            flex-direction: column; 
            align-items: center;
            cursor: pointer; 
            transition: all 0.3s;
            padding: 5px;
        }
        
        .character-progress.locked {
            opacity: 0.6; 
            cursor: not-allowed;
            filter: grayscale(0.8);
        }
        
        .character-progress.completed {
            opacity: 1;
        }
        
        .character-progress.completed .progress-icon {
            background: var(--success-color);
            box-shadow: 0 0 15px rgba(122, 163, 91, 0.5);
            border-color: var(--accent-color);
        }
        
        .progress-icon {
            width: 64px; 
            height: 64px; 
            border-radius: 50%;
            background: rgba(0,0,0,0.3);
            display: flex; 
            align-items: center; 
            justify-content: center;
            font-size: 36px; 
            margin-bottom: 5px;
            border: 4px solid rgba(255,255,255,0.4);
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        .character-progress.active .progress-icon {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(242, 232, 201, 0.9); 
            border-color: var(--accent-color);
        }
                
        .progress-name {
            font-size: 11px; 
            color: white; 
            font-weight: 700;
            background-color: rgba(0,0,0,0.4);
            padding: 2px 8px;
            border-radius: 10px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            letter-spacing: 0.5px;
        }

        /* –ö–Ω–æ–ø–∫–∞ —Ñ–æ—Ç–æ */
        .controls-bar {
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            z-index: 1000;
            background: none; /* –£–±—Ä–∞–Ω —Ñ–æ–Ω */
            padding: 25px 20px calc(max(env(safe-area-inset-bottom), 20px) + 25px) 20px;
            display: flex; 
            justify-content: center; 
            align-items: center;
            pointer-events: auto;
        }
        
        .photo-btn {
            width: 80px; 
            height: 80px; 
            border-radius: 50%; 
            background: var(--white-color);
            border: 6px solid var(--primary-color); 
            cursor: pointer;
            transition: all 0.2s; 
            position: relative; 
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .photo-btn:active { 
            transform: scale(0.9); 
            box-shadow: 0 3px 15px rgba(0,0,0,0.3);
        }
        
        .photo-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 42px;
        }
        
        .photo-btn.disabled {
            opacity: 0.6; 
            cursor: not-allowed;
            filter: grayscale(0.8);
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–∞—Ç–∞ */
        .chat-modal {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: rgba(42, 36, 30, 0.85); 
            z-index: 5000;
            display: none; 
            align-items: center; 
            justify-content: center;
            backdrop-filter: blur(8px);
        }
        
        .chat-modal.active { display: flex; }
        
        .chat-content {
            width: 100%; 
            max-width: 500px; 
            height: 92%;
            background: var(--accent-color);
            border-radius: 20px;
            padding: 20px; 
            display: flex; 
            flex-direction: column;
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            border: 5px solid var(--primary-color);
            margin: 20px;
        }
        
        .chat-header {
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            margin-bottom: 15px; 
            padding-bottom: 12px; 
            border-bottom: 3px solid var(--primary-color);
        }
        
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-title-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chat-header h1 {
            font-size: 24px;
            color: var(--primary-color);
            font-weight: 700;
            margin: 0;
        }
        
        #chat-character-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.5);
            border: 2px solid var(--primary-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        #chat-character-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .chat-container {
            flex-grow: 1; 
            overflow-y: auto; 
            padding: 15px;
            background: rgba(255,255,255,0.6); 
            border-radius: 15px; 
            margin-bottom: 15px;
            border: 2px solid rgba(217, 160, 92, 0.3);
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) var(--accent-color);
        }
        
        .chat-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .chat-container::-webkit-scrollbar-track {
            background: var(--accent-color);
            border-radius: 10px;
        }
        
        .chat-container::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 10px;
        }
        
        .message {
            margin-bottom: 18px; 
            animation: messageSlideIn 0.4s ease-out;
        }
        
        @keyframes messageSlideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.character {
            display: flex; 
            flex-direction: column; 
            align-items: flex-start;
        }
        
        .message.user {
            display: flex; 
            flex-direction: column; 
            align-items: flex-end;
        }
        
        .message-bubble {
            background: var(--white-color);
            padding: 14px 18px;
            border-radius: 20px 20px 20px 5px; 
            max-width: 80%;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
            border: 2px solid rgba(217, 160, 92, 0.4);
            position: relative;
        }
        
        .message.user .message-bubble {
            background: var(--secondary-color);
            border-radius: 20px 20px 5px 20px;
            border-color: transparent;
        }
        
        .message-text {
            font-size: 15px; 
            line-height: 1.5; 
            color: var(--text-color);
            font-weight: 500;
        }

        .message.user .message-text {
            color: var(--white-color);
        }
        
        .message-image {
            max-width: 100%; 
            border-radius: 15px; 
            margin-top: 12px;
            cursor: pointer; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border: 3px solid white;
            transition: transform 0.2s;
        }
        
        .message-image:active {
            transform: scale(0.98);
        }
        
        .message audio {
            width: 100%; 
            margin-top: 12px; 
            border-radius: 12px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.15));
        }

        /* –ö–Ω–æ–ø–∫–∏ –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
        .user-response-buttons {
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
            padding: 10px 0;
        }
        
        .response-btn {
            background: var(--secondary-color); 
            color: var(--white-color); 
            border: none;
            padding: 16px 22px; 
            border-radius: 15px;
            font-size: 16px; 
            cursor: pointer; 
            text-align: center;
            transition: all 0.2s; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            font-weight: 700;
        }
        
        .response-btn:active { 
            transform: scale(0.97) translateY(2px); 
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .response-btn.secondary {
            background: var(--disabled-color);
        }

        /* AI —á–∞—Ç */
        .ai-chat-controls {
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
            align-items: center;
        }
        
        .record-btn {
            width: 76px; 
            height: 76px; 
            border-radius: 50%; 
            border: 4px solid var(--white-color);
            font-size: 38px; 
            cursor: pointer; 
            transition: all 0.3s;
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }
        
        .record-btn.idle { 
            background: var(--primary-color);
        }
        
        .record-btn.recording { 
            background: #e74c3c; /* A classic red for recording */
            transform: scale(1.1);
        }
        
        .record-btn.processing { 
            background: var(--disabled-color); 
            cursor: not-allowed; 
        }
                
        .chat-status {
            font-size: 14px;
            color: var(--text-color);
            text-align: center;
            font-weight: 600;
            background: rgba(217, 160, 92, 0.2);
            padding: 8px 16px;
            border-radius: 15px;
        }
        
        .typing-indicator {
            display: inline-flex;
            align-items: center;
            padding: 8px 15px;
            background: var(--white-color);
            border-radius: 20px 5px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
            border: 2px solid rgba(217, 160, 92, 0.4);
        }
        
        .typing-indicator span {
            height: 8px;
            width: 8px;
            background: var(--text-color);
            border-radius: 50%;
            display: inline-block;
            margin: 0 2px;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–æ—Ç–æ */
        .image-viewer-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); 
            z-index: 6000; display: none; 
            align-items: center; justify-content: center;
            flex-direction: column; padding: 20px;
        }
        
        .image-viewer-modal.active { display: flex; }
        
        .viewer-image {
            max-width: 90%; max-height: 70vh; border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); margin-bottom: 25px;
            border: 5px solid var(--accent-color);
        }
        
        .viewer-actions { display: flex; gap: 15px; }
        
        .viewer-btn {
            padding: 14px 28px; border-radius: 30px; 
            border: 3px solid var(--white-color); font-size: 17px; 
            font-weight: 700; cursor: pointer; transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .viewer-btn.download { background: var(--success-color); color: #fff; }
        .viewer-btn.close { background: var(--disabled-color); color: #fff; }
        .viewer-btn:active { transform: scale(0.95); }

        /* –§–∏–Ω–∞–ª—å–Ω–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .final-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            z-index: 7000; display: none; align-items: center; justify-content: center;
            padding: 20px;
        }
        
        .final-modal.active { display: flex; }
        
        .final-content {
            background: var(--accent-color); 
            border: 6px solid var(--primary-color);
            border-radius: 20px; padding: 40px 30px;
            max-width: 500px; width: 100%; text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            position: relative;
        }
        
        .final-content::before,
        .final-content::after {
            content: 'üéâ'; position: absolute; font-size: 40px;
        }
        
        .final-content::before { top: -20px; left: 20px; transform: rotate(-15deg); }
        .final-content::after { top: -20px; right: 20px; transform: rotate(15deg); }
        
        .final-content h1 {
            font-size: 34px; color: var(--primary-color); 
            margin-bottom: 20px; font-weight: 700;
        }
        
        .final-content .promo-code {
            background: var(--success-color);
            color: var(--white-color);
            font-size: 32px;
            font-weight: 700;
            padding: 22px;
            border-radius: 15px;
            margin: 28px auto;      /* —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ */
            letter-spacing: 4px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
            border: 4px solid var(--white-color);
            display: inline-block;  /* —á—Ç–æ–±—ã margin:auto —Å—Ä–∞–±–æ—Ç–∞–ª */
            text-align: center;     /* –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –≤–Ω—É—Ç—Ä–∏ */
        }
        
        .tickets-btn {
            background: var(--primary-color); 
            color: var(--white-color); 
            border: none;
            padding: 18px 45px; 
            border-radius: 50px; 
            font-size: 19px;
            font-weight: 700; cursor: pointer; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }
        
        .tickets-btn:active {
            transform: scale(0.95) translateY(3px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .loading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(42, 36, 30, 0.9); 
            z-index: 8000;
            display: none; flex-direction: column; 
            align-items: center; justify-content: center; 
            gap: 25px;
        }
        
        .loading.active { display: flex; }
        
        .spinner {
            width: 60px; height: 60px; 
            border: 5px solid var(--accent-color);
            border-top-color: var(--primary-color); 
            border-radius: 50%; 
            animation: spin 1s linear infinite;
        }

        .progress-icon {
        position: relative;
        width: 64px;
        height: 64px;
        border-radius: 50%;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        }

        .progress-icon img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        position: absolute;
        top: 0;
        left: 0;
        transition: opacity 0.3s;
        }

        .buy-tickets-ar-btn {
            position: absolute;
            bottom: calc(env(safe-area-inset-bottom) + 4px); /* –±—ã–ª–æ +120px */
            background: linear-gradient(135deg, #d9a05c, #e7b874);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 10px 20px; /* —É–º–µ–Ω—å—à–µ–Ω–∞ –≤—ã—Å–æ—Ç–∞ –∫–Ω–æ–ø–∫–∏ */
            font-size: 14px;    /* —É–º–µ–Ω—å—à–µ–Ω —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ */
            font-weight: 700;
            box-shadow: 0 6px 15px rgba(0,0,0,0.25);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .buy-tickets-ar-btn:active {
            transform: scale(0.96) translateY(3px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.25);
        }

        /* –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∏–¥–Ω–∞ –æ–±—ã—á–Ω–∞—è –∏–∫–æ–Ω–∫–∞ */
        .progress-icon .icon-default { opacity: 1; }
        .progress-icon .icon-filled { opacity: 0; }

        /* –î–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–ª–∏ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—É—é" */
        .character-progress.active .icon-default,
        .character-progress.completed .icon-default { opacity: 0; }

        .character-progress.active .icon-filled,
        .character-progress.completed .icon-filled { opacity: 1; }

        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .loading-text {
            color: var(--white-color);
            font-size: 18px;
            font-weight: 700;
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
        @media (max-width: 480px) {
            .intro-content {
                padding: 20px 15px;
                border-width: 4px;
                max-height: 85vh;
            }
            
            .intro-content h1 {
                font-size: 22px;
                margin-bottom: 15px;
            }
            
            .intro-content .story {
                font-size: 13px;
                padding: 12px;
                margin-bottom: 15px;
            }
            
            .intro-content .characters-preview {
                gap: 8px;
                margin: 15px 0;
            }
            
            .character-icon-preview {
                width: 50px;
                height: 50px;
            }
            
            .start-quest-btn {
                padding: 14px 30px;
                font-size: 16px;
            }
        }
        
        @media (max-height: 700px) {
            .intro-content {
                padding: 15px;
            }
            
            .intro-content h1 {
                font-size: 20px;
                margin-bottom: 10px;
            }
            
            .intro-content .story {
                font-size: 12px;
                padding: 10px;
                margin-bottom: 12px;
            }
            
            .character-icon-preview {
                width: 45px;
                height: 45px;
            }
        }
        
        /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π iPhone */
        @media screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) { /* iPhone 6/7/8 */
            .intro-content {
                max-height: 75vh;
                padding: 15px 10px;
            }
            
            .intro-content h1 {
                font-size: 19px;
            }
            
            .intro-content .story {
                font-size: 11px;
                padding: 8px;
                line-height: 1.5;
            }
            
            .character-icon-preview {
                width: 40px;
                height: 40px;
            }
            
            .start-quest-btn {
                padding: 12px 20px;
                font-size: 15px;
            }
        }
        
        @media screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) { /* iPhone X, 11 Pro */
            .intro-content {
                max-height: 80vh;
                padding: 20px 12px;
            }
            
            .intro-content h1 {
                font-size: 22px;
            }
            
            .intro-content .story {
                font-size: 13px;
                line-height: 1.5;
                padding: 10px;
            }
        }
        
        @media screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) { /* iPhone XR, 11 */
            .intro-content {
                max-height: 78vh;
                padding: 20px 12px;
            }
        }
        
        /* –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è —Å—Ç–∞—Ä—Ç–æ–≤–æ–≥–æ —ç–∫—Ä–∞–Ω–∞ —Å —É—á–µ—Ç–æ–º —Ä–∞–±–æ—Ç—ã AR –∫–∞–º–µ—Ä—ã */
        @media (max-width: 480px) and (max-height: 700px) {
            .intro-content {
                padding: 20px 15px;
                max-height: 82vh;
            }
            
            .intro-content h1 {
                font-size: 22px;
                margin-bottom: 12px;
            }
            
            .intro-content .story {
                font-size: 12px;
                padding: 10px;
                margin-bottom: 15px;
                line-height: 1.5;
            }
            
            .intro-content .characters-preview {
                gap: 8px;
                margin: 15px 0;
            }
            
            .character-icon-preview {
                width: 50px;
                height: 50px;
            }
            
            .start-quest-btn {
                padding: 14px 25px;
                font-size: 16px;
            }
        }
        
        /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è iPhone X/XS/11 Pro (375x812) */
        @media screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) {
            .intro-content {
                padding: 22px 16px;
                max-height: 80vh;
            }
            
            .intro-content h1 {
                font-size: 23px;
            }
            
            .intro-content .story {
                font-size: 13px;
                padding: 12px;
            }
        }
        
        /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è iPhone 6/7/8 (375x667) */
        @media screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) {
            .intro-content {
                padding: 18px 14px;
                max-height: 82vh;
            }
            
            .intro-content h1 {
                font-size: 21px;
            }
            
            .intro-content .story {
                font-size: 12px;
                padding: 10px;
            }
        }
        
        /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è iPhone XR/11 (414x896) */
        @media screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) {
            .intro-content {
                padding: 24px 18px;
                max-height: 80vh;
            }
        }
    </style>
</head>
<body>
    <canvas id="capture-canvas" style="display: none;"></canvas>

    <a-scene id="ar-scene" 
      mindar-image="imageTargetSrc: ./assets/targets_all.mind; maxTrack: 1; autoStart: true; uiLoading: no; uiError: no; uiScanning: no; filterMinCF:0.0001; filterBeta: 0.01"
      color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights, antialias: true, alpha: true" 
      vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false" embedded>

        <a-assets>
            <a-asset-item id="zayac" src="./assets/zayac.glb"></a-asset-item>
            <a-asset-item id="cheb" src="./assets/oranges.glb"></a-asset-item>
            <a-asset-item id="gena" src="./assets/sign.glb"></a-asset-item>
            <a-asset-item id="shap" src="./assets/case.glb"></a-asset-item>
            <audio id="target-cheb-audio" src="./assets/cheba-song.mp3" preload="auto" loop></audio>
            <audio id="target-volc-audio" src="./assets/volc-song.mp3" preload="auto" loop></audio>
            <audio id="target-gena-audio" src="./assets/gena-song.mp3" preload="auto" loop></audio>
            <audio id="target-shap-audio" src="./assets/shap-song.mp3" preload="auto" loop></audio>
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false" cursor="rayOrigin: mouse"></a-camera>

        <a-entity id="target-cheb" mindar-image-target="targetIndex: 0">
          <a-gltf-model rotation="0 -90 -20" position="0 -1 -1" scale="0.5 0.5 0.5" src="#cheb" animation-mixer="clip: *; loop: repeat;"></a-gltf-model>
        </a-entity>
        <a-entity id="target-volc" mindar-image-target="targetIndex: 1">
          <a-gltf-model rotation="0 0 0" position="-0.5 -1 -1" scale="0.5 0.5 0.5" src="#zayac" animation-mixer="clip: *; loop: repeat;"></a-gltf-model>
        </a-entity>
        <a-entity id="target-gena" mindar-image-target="targetIndex: 2">
            <a-gltf-model rotation="0 270 -20" position="-1 -2 -2" scale="1 1 1" src="#gena"></a-gltf-model>
        </a-entity>
        <a-entity id="target-shap" mindar-image-target="targetIndex: 3">
            <a-gltf-model rotation="0 225 0" position="-0.5 -1 -1" scale="1 1 1" src="#shap"></a-gltf-model>
        </a-entity>
        <a-entity id="target-cheb-night" mindar-image-target="targetIndex: 4">
          <a-gltf-model rotation="0 -90 -20" position="0 -1 -1" scale="0.5 0.5 0.5" src="#cheb" animation-mixer="clip: *; loop: repeat;"></a-gltf-model>
        </a-entity>
        <a-entity id="target-volc-night" mindar-image-target="targetIndex: 5">
          <a-gltf-model rotation="0 0 0" position="-0.5 -1 -1" scale="0.5 0.5 0.5" src="#zayac" animation-mixer="clip: *; loop: repeat;"></a-gltf-model>
        </a-entity>
        <a-entity id="target-gena-night" mindar-image-target="targetIndex: 6">
            <a-gltf-model rotation="0 270 -20" position="-1 -2 -2" scale="1 1 1" src="#gena"></a-gltf-model>
        </a-entity>
        <a-entity id="target-shap-night" mindar-image-target="targetIndex: 7">
            <a-gltf-model rotation="0 225 0" position="-0.5 -1 -1" scale="1 1 1" src="#shap"></a-gltf-model>
        </a-entity>        
    </a-scene>

    <div class="intro-modal" id="intro-modal">
        <div class="intro-content">
            <h1>üé≠ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h1>
            <div class="story">
                <p><strong>–¢–≤–æ—è –º–∏—Å—Å–∏—è:</strong> –ù–∞–π–¥–∏ –≤—Å–µ—Ö —á–µ—Ç—ã—Ä–µ—Ö –ª–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π —Å–æ–≤–µ—Ç—Å–∫–∏—Ö –º—É–ª—å—Ç—Ñ–∏–ª—å–º–æ–≤!</p>
                <br>
                <p>–ö–∞–∂–¥—ã–π –∏–∑ –Ω–∏—Ö –ø—Ä–∏–≥–æ—Ç–æ–≤–∏–ª –¥–ª—è —Ç–µ–±—è –æ—Å–æ–±–æ–µ –∑–∞–¥–∞–Ω–∏–µ. –ü–æ–¥–æ–π–¥–∏ –∫ —Å—Ç–∞—Ç—É–µ, —Å—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π—Å—è —Å –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–º –≤ AR –∏ –ø–æ–æ–±—â–∞–π—Å—è —Å –Ω–∏–º!</p>
                <br>
                <p>–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –∑–∞–¥–∞–Ω–∏–π —Ç–µ–±—è –∂–¥—ë—Ç <strong>—Å–µ–∫—Ä–µ—Ç–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥</strong> –Ω–∞ –±–∏–ª–µ—Ç—ã –≤ –ø–∞—Ä–∫! üé´</p>
            </div>
            <div class="characters-preview">
                <div class="character-icon-preview">
                    <img src="./assets/icons/cheb.png" alt="–ß–µ–±—É—Ä–∞—à–∫–∞">
                </div>
                <div class="character-icon-preview">
                    <img src="./assets/icons/gena.png" alt="–ö—Ä–æ–∫–æ–¥–∏–ª –ì–µ–Ω–∞">
                </div>
                <div class="character-icon-preview">
                    <img src="./assets/icons/shap.png" alt="–®–∞–ø–æ–∫–ª—è–∫">
                </div>
                <div class="character-icon-preview">
                    <img src="./assets/icons/volc.png" alt="–í–æ–ª–∫">
                </div>
            </div>
            <button class="start-quest-btn" onclick="startQuest()">–ù–∞—á–∞—Ç—å –∫–≤–µ—Å—Ç!</button>
        </div>
    </div>

    <div class="progress-bar" id="progress-bar" style="display: none;">
        <div class="character-progress locked" id="progress-cheb" onclick="openCharacterFromProgress('cheb')">
            <div class="progress-icon">
                <img src="./assets/icons/cheb_0.png" class="icon-default">
                <img src="./assets/icons/cheb.png" class="icon-filled">
            </div>
            <div class="progress-name">–ß–µ–±—É—Ä–∞—à–∫–∞</div>
        </div>
        <div class="character-progress locked" id="progress-gena" onclick="openCharacterFromProgress('gena')">
            <div class="progress-icon">
                <img src="./assets/icons/gena_0.png" class="icon-default">
                <img src="./assets/icons/gena.png" class="icon-filled">
            </div>
            <div class="progress-name">–ì–µ–Ω–∞</div>
        </div>
        <div class="character-progress locked" id="progress-shap" onclick="openCharacterFromProgress('shap')">
            <div class="progress-icon">
                <img src="./assets/icons/shap_0.png" class="icon-default">
                <img src="./assets/icons/shap.png" class="icon-filled">
            </div>
            <div class="progress-name">–®–∞–ø–æ–∫–ª—è–∫</div>
        </div>
        <div class="character-progress locked" id="progress-volc" onclick="openCharacterFromProgress('volc')">
            <div class="progress-icon">
                <img src="./assets/icons/volc_0.png" class="icon-default">
                <img src="./assets/icons/volc.png" class="icon-filled">
            </div>
            <div class="progress-name">–í–æ–ª–∫</div>
        </div>
    </div>

    <div class="controls-bar" id="controls-bar" style="display: none;">
        <button class="photo-btn" id="photo-btn" onclick="takePhoto()"></button>
        <button class="buy-tickets-ar-btn" onclick="buyTickets()">–ö—É–ø–∏—Ç—å –±–∏–ª–µ—Ç—ã –≤ –°–æ—é–∑–ú—É–ª—å—Ç–ü–∞—Ä–∫</button>
    </div>

    <div class="chat-modal" id="chat-modal">
        <div class="chat-content">
            <div class="chat-header">
              <div class="chat-title-container">
                <span id="chat-character-icon"></span>
                <h1 id="chat-title">–ß–∞—Ç</h1>
              </div>
              <button id="exit-ai-btn" onclick="exitAIChat()" style="
                  display: none;
                  background: var(--disabled-color);
                  color: white; border: none;
                  border-radius: 12px; padding: 8px 14px;
                  font-size: 14px; font-weight: 700;
                  cursor: pointer; box-shadow: 0 3px 8px rgba(0,0,0,0.2);
              ">üö™ –í—ã–π—Ç–∏</button>
            </div>
            <div class="chat-container" id="chat-container"></div>
            <div id="chat-controls"></div>
        </div>
    </div>

    <div class="image-viewer-modal" id="image-viewer">
        <img id="viewer-image" class="viewer-image" alt="–§–æ—Ç–æ">
        <div class="viewer-actions">
            <button class="viewer-btn download" onclick="downloadImage()">üíæ –°–∫–∞—á–∞—Ç—å</button>
            <button class="viewer-btn close" onclick="closeImageViewer()">‚úñ –ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <div class="final-modal" id="final-modal">
        <div class="final-content">
            <h1>üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</h1>
            <p style="font-size: 18px; margin: 20px 0; color: var(--text-color); font-weight: 600;">–¢—ã –ø—Ä–æ—à—ë–ª –≤–µ—Å—å –∫–≤–µ—Å—Ç –∏ –ø–æ–∑–Ω–∞–∫–æ–º–∏–ª—Å—è —Å–æ –≤—Å–µ–º–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º–∏!</p>
            <div class="promo-code" id="promo-code">PROMO2025</div>
            <p style="font-size: 14px; color: #7f8c8d; margin-bottom: 25px; font-weight: 600;">–ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ—Ç –ø—Ä–æ–º–æ–∫–æ–¥ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ –±–∏–ª–µ—Ç–æ–≤</p>
            <button class="tickets-btn" onclick="buyTickets()">üé´ –ö—É–ø–∏—Ç—å –±–∏–ª–µ—Ç—ã</button>
        </div>
    </div>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div class="loading-text">–û–±—Ä–∞–±–æ—Ç–∫–∞...</div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        const SESSION_ID = 'session-' + Math.random().toString(36).substr(2, 9);
        let currentlyPlayingAudio = null; // –î–ª—è –≥–æ–ª–æ—Å–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
        let currentArAudio = null; // –î–ª—è AR-–º—É–∑—ã–∫–∏
        let isChatOpen = false; // –°–æ—Å—Ç–æ—è–Ω–∏–µ —á–∞—Ç–∞
        let activeCharacter = null;
        let currentChatCharacter = null;
        let processedImage = null;
        let photoWaitNoticeShown = false;
        let processingDone = false;     // –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å (—É—Å–ø–µ—Ö –∏–ª–∏ –æ—à–∏–±–∫–∞)
        let processingError = false;    // –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å –æ—à–∏–±–∫–æ–π
        let questState = {
            cheb: { completed: false, photo: null },
            gena: { completed: false, photo: null },
            shap: { completed: false, photo: null },
            volc: { completed: false, photo: null }
        };
        let aiTypingIndicator = null; // –î–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –ø–µ—á–∞—Ç–∏ –ò–ò
        const audioCache = new Map();

        const characterData = {
            cheb: {
                name: "–ß–µ–±—É—Ä–∞—à–∫–∞",
                emoji: "üê≠",
                dialog: [
                    { type: 'character', text: '–ü—Ä–∏–≤–µ—Ç! –°–µ–π—á–∞—Å —Å—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É—é... ‚è≥', audio: './assets/dialogues/cheb-1.mp3' },
                    { type: 'user', text: '–ü—Ä–∏–≤–µ—Ç, –ß–µ–±—É—Ä–∞—à–∫–∞!' },
                    { type: 'character', text: '–Ø —Ä–∞–Ω—å—à–µ –≤ —è—â–∏–∫–µ —Å –∞–ø–µ–ª—å—Å–∏–Ω–∞–º–∏ –∂–∏–ª. –ê —Ç–µ–ø–µ—Ä—å —É –º–µ–Ω—è —Å–≤–æ–π –¥–æ–º–∏–∫ –µ—Å—Ç—å!', audio: './assets/dialogues/cheb-2.mp3' },
                    { type: 'user', text: '–ö–∞–∫–æ–π –¥–æ–º–∏–∫?' },
                    { type: 'character', text: '–í –°–æ—é–∑–ú—É–ª—å—Ç–ü–∞—Ä–∫–µ! –¢–∞–º –≤–∏–¥–µ–æ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ —Å–Ω–∏–º–∞—Ç—å –º–æ–∂–Ω–æ, –≥–µ—Ä–æ–µ–≤ –æ–∂–∏–≤–ª—è—Ç—å, —Å –í–∏–Ω–Ω–∏-–ü—É—Ö–æ–º –º—ë–¥ –∏—Å–∫–∞—Ç—å!', audio: './assets/dialogues/cheb-3.mp3' },
                    { type: 'user', text: '–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ!' },
                    { type: 'character', text: '–§–æ—Ç–æ –≥–æ—Ç–æ–≤–æ! üì∏ –ü—Ä–∏—Ö–æ–¥–∏ –≤ –≥–æ—Å—Ç–∏, –±—É–¥–µ—Ç –≤–µ—Å–µ–ª–æ! üòä –ë–∏–ª–µ—Ç—ã –Ω–∞ <a href="https://souzmultpark.ru" target="_blank">souzmultpark.ru</a>', audio: './assets/dialogues/cheb-4.mp3' },
                ]
            },
            gena: {
                name: "–ö—Ä–æ–∫–æ–¥–∏–ª –ì–µ–Ω–∞",
                emoji: "üêä",
                dialog: [
                    { type: 'character', text: '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –°–µ–π—á–∞—Å —Å–¥–µ–ª–∞—é –≤–∞—à–µ —Ñ–æ—Ç–æ... ‚è≥', audio: './assets/dialogues/gena-1.mp3' },
                    { type: 'user', text: '–ü—Ä–∏–≤–µ—Ç, –ì–µ–Ω–∞!' },
                    { type: 'character', text: '–†–∞–Ω—å—à–µ —è –≤ –∑–æ–æ–ø–∞—Ä–∫–µ —Ä–∞–±–æ—Ç–∞–ª –∫—Ä–æ–∫–æ–¥–∏–ª–æ–º. –°–∫—É—á–Ω–æ –±—ã–ª–æ! –ê —Å–µ–π—á–∞—Å —Å—Ç–æ–ª—å–∫–æ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π –≤–æ–∫—Ä—É–≥...', audio: './assets/dialogues/gena-2.mp3' },
                    { type: 'user', text: '–ê —á—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å?' },
                    { type: 'character', text: '–í –°–æ—é–∑–ú—É–ª—å—Ç–ü–∞—Ä–∫–µ –º–æ–∂–Ω–æ –≤ VR –º—É–ª—å—Ç—Ñ–∏–ª—å–º –Ω–∞—Ä–∏—Å–æ–≤–∞—Ç—å, –Ω–∞ –¥–∏—Ä–∏–∂–∞–±–ª–µ –ø–æ–ª–µ—Ç–∞—Ç—å, –≤ –∫—É–ø–æ–ª—å–Ω–æ–º –∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä–µ –ø–æ–ª–µ–∂–∞—Ç—å. 18 –∞—Ç—Ç—Ä–∞–∫—Ü–∏–æ–Ω–æ–≤!', audio: './assets/dialogues/gena-3.mp3' },
                    { type: 'user', text: '–ö—Ä—É—Ç–æ!' },
                    { type: 'character', text: '–§–æ—Ç–æ –≥–æ—Ç–æ–≤–æ! üì∏ –ï—Å–ª–∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ ‚Äî –±–∏–ª–µ—Ç—ã –Ω–∞ <a href="https://souzmultpark.ru" target="_blank">souzmultpark.ru</a>', audio: './assets/dialogues/gena-4.mp3' },
                ]
            },
            shap: {
                name: "–®–∞–ø–æ–∫–ª—è–∫",
                emoji: "üëµ",
                dialog: [
                    { type: 'character', text: '–õ–∞—Ä–∏—Å–∫–∞, —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π! ‚è≥', audio: './assets/dialogues/shap-1.mp3' },
                    { type: 'user', text: '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!' },
                    { type: 'character', text: '–†–∞–Ω—å—à–µ –º—ã —Å –õ–∞—Ä–∏—Å–∫–æ–π –ø–æ –≥–æ—Ä–æ–¥—É –ø–∞–∫–æ—Å—Ç–∏ –¥–µ–ª–∞–ª–∏. –°–∫—É—á–Ω–æ –±—ã–ª–æ!', audio: './assets/dialogues/shap-2.mp3' },
                    { type: 'user', text: '–ò –∫–∞–∫ —Ç–µ–ø–µ—Ä—å?' },
                    { type: 'character', text: '–í –°–æ—é–∑–ú—É–ª—å—Ç–ü–∞—Ä–∫–µ –º–æ–∂–Ω–æ –≤ —Ç–∏—Ä–µ —Å—Ç—Ä–µ–ª—è—Ç—å, –Ω–∞ –∫–æ—Ä–∞–±–ª–µ –ü–µ–≥–∞—Å –ª–µ—Ç–∞—Ç—å, –ø–æ –∫—Ä—ã—à–∞–º —Å –ö–∞—Ä–ª—Å–æ–Ω–æ–º –ø—Ä—ã–≥–∞—Ç—å! –õ–∞—Ä–∏—Å–∫–∞ –≤ –≤–æ—Å—Ç–æ—Ä–≥–µ.', audio: './assets/dialogues/shap-3.mp3' },
                    { type: 'user', text: '–ú–æ–ª–æ–¥—Ü—ã!' },
                    { type: 'character', text: '–ì–æ—Ç–æ–≤–æ! üì∏ –ó–∞—Ö–æ–¥–∏, –µ—Å–ª–∏ –Ω–µ –±–æ–∏—à—å—Å—è –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–π! üòè <a href="https://souzmultpark.ru" target="_blank">souzmultpark.ru</a>', audio: './assets/dialogues/shap-4.mp3' },
                ]
            },
            volc: {
                name: "–í–æ–ª–∫",
                emoji: "üê∫",
                dialog: [
                    { type: 'character', text: '–©–∞—Å –∑–∞–ø–µ—á–∞—Ç–ª–µ—é... ‚è≥', audio: './assets/dialogues/volc-1.mp3' },
                    { type: 'user', text: '–ü—Ä–∏–≤–µ—Ç, –í–æ–ª–∫!' },
                    { type: 'character', text: '–Ø –ó–∞–π—Ü–∞ –≥–æ–Ω—è–ª –≤—Å—é –∂–∏–∑–Ω—å. –£—Å—Ç–∞–ª —É–∂–µ! –ê —Ç—É—Ç —É–∑–Ω–∞–ª ‚Äî –≤ –ø–∞—Ä–∫–µ –Ω–∞—Å –æ–±–æ–∏—Ö –Ω–∞ —ç–∫—Ä–∞–Ω–µ –º–æ–∂–Ω–æ —É–≤–∏–¥–µ—Ç—å.', audio: './assets/dialogues/volc-2.mp3' },
                    { type: 'user', text: '–ö–∞–∫ —ç—Ç–æ?' },
                    { type: 'character', text: '–†–∞—Å–∫—Ä–∞—à–∏–≤–∞–µ—à—å ‚Äî –∏ –º—ã –æ–∂–∏–≤–∞–µ–º! –ü–ª—é—Å VR, –¥–∂—É–Ω–≥–ª–∏ —Å –ú–∞—É–≥–ª–∏, —Ç—Ä–æ–Ω –≤ –¢—Ä–∏–¥–µ–≤—è—Ç–æ–º —Ü–∞—Ä—Å—Ç–≤–µ. 18 –∞—Ç—Ç—Ä–∞–∫—Ü–∏–æ–Ω–æ–≤.', audio: './assets/dialogues/volc-3.mp3' },
                    { type: 'user', text: '–ü—Ä–∏–∫–æ–ª—å–Ω–æ!' },
                    { type: 'character', text: '–î–µ—Ä–∂–∏ —Ñ–æ—Ç–æ! üì∏ –ë–∏–ª–µ—Ç—ã –Ω–∞ <a href="https://souzmultpark.ru" target="_blank">souzmultpark.ru</a>. –ü–æ–±–µ–∂–∞–ª! üòé', audio: './assets/dialogues/volc-4.mp3' },
                ]
            }
        };

        async function preloadDialogAudios() {
          const urls = [...new Set(
            Object.values(characterData)
              .flatMap(c => c.dialog.filter(m => m.audio).map(m => m.audio))
          )];

          await Promise.all(urls.map(async (url) => {
            if (audioCache.has(url)) return;
            const res = await fetch(url, { cache: 'force-cache' });
            const buf = await res.arrayBuffer();
            const blob = new Blob([buf], { type: 'audio/mpeg' });
            const objectUrl = URL.createObjectURL(blob);
            audioCache.set(url, objectUrl);
          }));
        }

        window.addEventListener('load', () => {
          preloadDialogAudios().catch(console.warn);
        });


        // –°—Ç–∞—Ä—Ç –∫–≤–µ—Å—Ç–∞
        function startQuest() {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞—É–¥–∏–æ-–∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–∞ –Ω–∞ iOS
            const audios = [
                document.getElementById('target-cheb-audio'),
                document.getElementById('target-volc-audio'),
                document.getElementById('target-gena-audio'),
                document.getElementById('target-shap-audio')
            ];
        
            for (const audio of audios) {
                try {
                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞—É–¥–∏–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç, –Ω–æ –ù–ï –∑–∞–ø—É—Å–∫–∞–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
                    audio.load();
                } catch (e) {
                    console.warn('Audio init failed', e);
                }
            }
        
            document.getElementById('intro-modal').classList.add('hidden');
            document.getElementById('progress-bar').style.display = 'flex';
            document.getElementById('controls-bar').style.display = 'flex';
        }

        // AR –ª–æ–≥–∏–∫–∞
        document.addEventListener('DOMContentLoaded', () => {
            const sceneEl = document.querySelector('a-scene');
            const targets = [
              { 
                  id: "cheb", 
                  entities: [
                      document.querySelector('#target-cheb'),
                      document.querySelector('#target-cheb-night')
                  ], 
                  audio: document.getElementById('target-cheb-audio') 
              },
              { 
                  id: "volc", 
                  entities: [
                      document.querySelector('#target-volc'),
                      document.querySelector('#target-volc-night')
                  ], 
                  audio: document.getElementById('target-volc-audio') 
              },
              { 
                  id: "gena", 
                  entities: [
                      document.querySelector('#target-gena'),
                      document.querySelector('#target-gena-night')
                  ], 
                  audio: document.getElementById('target-gena-audio') 
              },
              { 
                  id: "shap", 
                  entities: [
                      document.querySelector('#target-shap'),
                      document.querySelector('#target-shap-night')
                  ], 
                  audio: document.getElementById('target-shap-audio') 
              },
          ];

          targets.forEach(target => {
              target.entities.forEach(entity => {
                  if (!entity) return; // –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å, –µ—Å–ª–∏ entity –Ω–µ –Ω–∞–π–¥–µ–Ω
                  
                  entity.addEventListener('targetFound', () => {
                      activeCharacter = target.id;
                      document.getElementById(`progress-${target.id}`).classList.add('active');
                      
                      if (target.audio) {
                          target.audio.volume = isChatOpen ? 0.2 : 1.0;
                          target.audio.play().catch(e => console.warn("Audio play failed:", e));
                          currentArAudio = target.audio;
                      }
                  });

                  entity.addEventListener('targetLost', () => {
                      activeCharacter = null;
                      document.getElementById(`progress-${target.id}`).classList.remove('active');
                      
                      if (currentArAudio === target.audio) {
                          currentArAudio.pause();
                          currentArAudio = null;
                      }
                  });
              });
          });
        });

        let isRandomCharacter = false; // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ä–∞–Ω–¥–æ–º–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞

        function openChatShell(character, random = false) {
            currentChatCharacter = character;
            isRandomCharacter = random;
            photoWaitNoticeShown = false;
            isChatOpen = true; // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–∞—Ç–∞

            const data = characterData[character];
            document.getElementById('chat-title').textContent = data.name;
            document.getElementById('chat-character-icon').innerHTML = `<img src="./assets/icons/${character}.png" alt="${data.name}">`;
            document.getElementById('chat-modal').classList.add('active');
            document.getElementById('chat-container').innerHTML = '';
            document.getElementById('chat-controls').innerHTML = '';
            
            // –£–º–µ–Ω—å—à–∏—Ç—å –≥—Ä–æ–º–∫–æ—Å—Ç—å AR-–º—É–∑—ã–∫–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —á–∞—Ç–∞
            if (currentArAudio) {
                currentArAudio.volume = 0.2;
            }
        }

        function startScriptedDialog(character) {
            const data = characterData[character];
            let currentStep = 0;

            function showNextMessage() {
                if (currentStep >= data.dialog.length) {
                    setTimeout(() => {
                        showProcessedPhoto(character);
                    }, 800);
                    return;
                }

                const message = data.dialog[currentStep];
                if (message.type === 'character') {
                    addCharacterMessage(message.text, message.audio);
                    currentStep++;

                    if (currentStep < data.dialog.length) {
                        const nextMsg = data.dialog[currentStep];
                        if (nextMsg.type === 'user') {
                            // –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–µ—Ä–∂–∫—É –≤ –ø–æ–ª—Å–µ–∫—É–Ω–¥—ã –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º –∫–Ω–æ–ø–∫–∏ –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                            setTimeout(() => {
                                showResponseButton(nextMsg.text, showNextMessage);
                            }, 500);
                        } else {
                            setTimeout(showNextMessage, message.audio ? 2000 : 1000);
                        }
                    } else {
                        setTimeout(showNextMessage, 800);
                    }
                } else if (message.type === 'user') {
                    currentStep++;
                    // –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–µ—Ä–∂–∫—É –≤ –ø–æ–ª—Å–µ–∫—É–Ω–¥—É –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
                    setTimeout(showNextMessage, 500);
                }
            }

            showNextMessage();
        }

        async function takePhoto() {
            let characterToUse = activeCharacter;
            
            // –ï—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ (AR-—Ü–µ–ª–∏), –≤—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–≥–æ
            if (!activeCharacter) {
                const characters = ['cheb', 'gena', 'shap', 'volc'];
                characterToUse = characters[Math.floor(Math.random() * characters.length)];
            } else {
                // –î–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ completed, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ —Å–Ω–æ–≤–∞ —Å –Ω–∏–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å
                // –ù–æ –æ—Å—Ç–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ, –µ—Å–ª–∏ –æ–Ω–æ —É–∂–µ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ
                if (questState[activeCharacter].completed) {
                    // –ù–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º completed, —á—Ç–æ–±—ã –Ω–µ —Ç–µ—Ä—è—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å, –Ω–æ —Ä–∞–∑—Ä–µ—à–∞–µ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ
                }
            }

            const sceneEl = document.querySelector('#ar-scene');
            const video = sceneEl.systems["mindar-image-system"].video;
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å –≤–∏–¥–µ–æ, –¥–µ–ª–∞–µ–º —Ñ–æ—Ç–æ —Å AR-–Ω–∞–ª–æ–∂–µ–Ω–∏–µ–º, –∏–Ω–∞—á–µ –ø—Ä–æ—Å—Ç–æ —Ñ–æ—Ç–æ
            let photoCanvas, arCanvas;
            if (video && video.videoWidth) {
                photoCanvas = document.createElement('canvas');
                photoCanvas.width = video.videoWidth;
                photoCanvas.height = video.videoHeight;
                photoCanvas.getContext('2d').drawImage(video, 0, 0);

                // –ï—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –ø–µ—Ä—Å–æ–Ω–∞–∂, –∏—Å–ø–æ–ª—å–∑—É–µ–º AR-–∫–∞–Ω–≤–∞—Å, –∏–Ω–∞—á–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –±–µ–∑ AR-—Å–ª–æ—è
                if (activeCharacter) {
                    arCanvas = sceneEl.canvas;
                } else {
                    // –î–ª—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ —Å–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π AR-–∫–∞–Ω–≤–∞—Å (–±–µ–∑ AR-—Å–ª–æ—è)
                    arCanvas = document.createElement('canvas');
                    arCanvas.width = photoCanvas.width;
                    arCanvas.height = photoCanvas.height;
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º, —á—Ç–æ–±—ã —Å–µ—Ä–≤–µ—Ä –∑–Ω–∞–ª, —á—Ç–æ AR-—Å–ª–æ—è –Ω–µ—Ç
                    arCanvas.getContext('2d').clearRect(0, 0, arCanvas.width, arCanvas.height);
                }
            } else {
                // –ï—Å–ª–∏ –Ω–µ—Ç AR-–≤–∏–¥–µ–æ, —Å–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π canvas
                photoCanvas = document.createElement('canvas');
                photoCanvas.width = 640;
                photoCanvas.height = 480;
                photoCanvas.getContext('2d').fillStyle = '#ffffff';
                photoCanvas.getContext('2d').fillRect(0, 0, 640, 480);

                // –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π AR-–∫–∞–Ω–≤–∞—Å
                arCanvas = document.createElement('canvas');
                arCanvas.width = photoCanvas.width;
                arCanvas.height = photoCanvas.height;
                arCanvas.getContext('2d').clearRect(0, 0, arCanvas.width, arCanvas.height);
            }

            openChatShell(characterToUse, !activeCharacter); // –ø–µ—Ä–µ–¥–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ —ç—Ç–æ —Ä–∞–Ω–¥–æ–º–Ω—ã–π –≤—ã–±–æ—Ä
            addCharacterMessage('–î–µ–ª–∞—é —Ç–≤–æ—ë —Ñ–æ—Ç–æ... ‚è≥');

            // ‚ñº —Å–±—Ä–æ—Å–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä—è–º–æ –∑–¥–µ—Å—å
            processedImage = null;
            photoWaitNoticeShown = false;
            processingDone = false;
            processingError = false;

            // –£–º–µ–Ω—å—à–∏—Ç—å –≥—Ä–æ–º–∫–æ—Å—Ç—å AR-–∞—É–¥–∏–æ –ø—Ä–∏ –Ω–∞—á–∞–ª–µ —Å—ä–µ–º–∫–∏
            if (currentArAudio) {
              currentArAudio.volume = 0.2;
            }

            setTimeout(() => startScriptedDialog(characterToUse), 300);

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ (—Å AR-—Ü–µ–ª—å—é –∏–ª–∏ –±–µ–∑)
            // –ï—Å–ª–∏ –Ω–µ—Ç AR-—Ü–µ–ª–∏, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–æ—Å—Ç–æ —Ñ–æ—Ç–æ –±–µ–∑ AR-—Å–ª–æ—è
            await sendToServerWithRetries(photoCanvas, arCanvas, characterToUse, 3);
          }

        async function canvasToBlob(canvas) {
            return new Promise(res => canvas.toBlob(res, 'image/png'));
        }

        async function sendToServerWithRetries(photoCanvas, arCanvas, targetId, attempts = 3) {
          try {
            const [photoBlob, arBlob] = await Promise.all([
              canvasToBlob(photoCanvas),
              canvasToBlob(arCanvas)
            ]);

            for (let tryNo = 1; tryNo <= attempts; tryNo++) {
              const ok = await trySend(photoBlob, arBlob, targetId, tryNo);
              if (ok) {
                processingDone = true;
                processingError = false;
                return true;
              }
            }

            // –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã ‚Äî –Ω–æ –ù–ò–ß–ï–ì–û –Ω–µ –≥–æ–≤–æ—Ä–∏–º –≤ —á–∞—Ç —Å–µ–π—á–∞—Å
            processingDone = true;
            processingError = true;
            return false;
          } catch (err) {
            console.error(err);
            processingDone = true;
            processingError = true;
            return false;
          }
        }

        async function trySend(photoBlob, arBlob, targetId, tryNo) {
          try {
            const formData = new FormData();
            formData.append('photo', photoBlob, 'photo.png');
            formData.append('ar_overlay', arBlob, 'ar_overlay.png');
            formData.append('active_target', targetId);

            const response = await fetch('/remove', { method: 'POST', body: formData });
            if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');

            const resultBlob = await response.blob();
            processedImage = URL.createObjectURL(resultBlob);
            questState[targetId].photo = processedImage;
            return true;
          } catch (error) {
            console.warn(`–ü–æ–ø—ã—Ç–∫–∞ ${tryNo} –Ω–µ —É–¥–∞–ª–∞—Å—å`, error);
            // ‚ö†Ô∏è –ù–µ –ø–∏—à–µ–º –Ω–∏—á–µ–≥–æ –≤ —á–∞—Ç, –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º false
            return false;
          }
        }

        function addCharacterMessage(text, audioSrc) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message character';
            msgDiv.innerHTML = `
                <div class="message-bubble">
                    <div class="message-text">${text}</div>
                </div>
            `;

            if (audioSrc) {
                // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ–µ –∞—É–¥–∏–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ (–Ω–æ –Ω–µ AR-–º—É–∑—ã–∫—É)
                if (currentlyPlayingAudio) {
                    currentlyPlayingAudio.pause();
                    currentlyPlayingAudio.currentTime = 0;
                }
                
                const audio = document.createElement('audio');
                audio.controls = true;
                const cached = audioCache.get(audioSrc) || audioSrc;
                audio.src = cached;
                msgDiv.querySelector('.message-bubble').appendChild(audio);
                
                // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –∞—É–¥–∏–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –∫–∞–∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ–µ
                currentlyPlayingAudio = audio;
                
                setTimeout(() => {
                    audio.play().catch(e => console.log('Audio failed'));
                }, 100);
            }

            document.getElementById('chat-container').appendChild(msgDiv);
            scrollChat();
        }

        function addUserMessage(text) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message user';
            msgDiv.innerHTML = `
                <div class="message-bubble">
                    <div class="message-text">${text}</div>
                </div>
            `;
            document.getElementById('chat-container').appendChild(msgDiv);
            scrollChat();
            
            // –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —É–±–µ–¥–∏–º—Å—è, —á—Ç–æ –æ–Ω–æ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ —Å –∞—É–¥–∏–æ
            // –û—Å—Ç–∞–≤–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –∞—É–¥–∏–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º—ã–º, –µ—Å–ª–∏ –æ–Ω–æ —É–∂–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è
        }

        function showResponseButton(text, onClick) {
          const controls = document.getElementById('chat-controls');
          controls.innerHTML = `
            <div class="user-response-buttons">
              <button class="response-btn" id="resp-btn">${text}</button>
            </div>
          `;
          const btn = document.getElementById('resp-btn');
          btn.onclick = () => {
            addUserMessage(text);
            controls.innerHTML = '';
            if (typeof onClick === 'function') {
              // –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–µ—Ä–∂–∫—É –≤ –ø–æ–ª—Å–µ–∫—É–Ω–¥—ã –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è
              setTimeout(() => {
                onClick();
              }, 500);
            }
          };
        }

        function showProcessedPhoto(character) {
          // 1) –§–æ—Ç–æ –≥–æ—Ç–æ–≤–æ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫ —Ä–∞–Ω—å—à–µ
          if (processedImage) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message character';
            msgDiv.innerHTML = `
              <div class="message-bubble">
                <div class="message-text">–í–æ—Ç —Ç–≤–æ—ë —Ñ–æ—Ç–æ! üì∏</div>
                <img src="${processedImage}" class="message-image" onclick="openImageViewer('${processedImage}')">
              </div>
            `;
            document.getElementById('chat-container').appendChild(msgDiv);
            scrollChat();
            setTimeout(() => showFinalButtons(character), 800);
            return;
          }

          // 2) –û–±—Ä–∞–±–æ—Ç–∫–∞ –µ—â—ë –∏–¥—ë—Ç ‚Äî –º—è–≥–∫–æ –ø–æ–¥–æ–∂–¥—ë–º (—Å–æ–æ–±—â–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑)
          if (!processingDone) {
            if (!photoWaitNoticeShown) {
              addCharacterMessage('–û–¥–Ω—É —Å–µ–∫—É–Ω–¥—É, —Ñ–æ—Ç–æ –ø–æ—á—Ç–∏ –≥–æ—Ç–æ–≤–æ... ‚è≥');
              photoWaitNoticeShown = true;
            }
            setTimeout(() => showProcessedPhoto(character), 1500);
            return;
          }

          // 3) –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å, –Ω–æ —Ñ–æ—Ç–æ –Ω–µ—Ç ‚Üí –µ–¥–∏–Ω–æ–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ —Ñ–æ—Ç–æ
          if (processingError) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message character';
            let errorMessage = '–ü–æ—Ö–æ–∂–µ, —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–æ—Ç–æ üòî';
            
            // –ï—Å–ª–∏ —ç—Ç–æ –±—ã–ª –Ω–µ —Ä–∞–Ω–¥–æ–º–Ω—ã–π –≤—ã–±–æ—Ä (—Ç.–µ. –±—ã–ª –≤—ã–±—Ä–∞–Ω –ø–µ—Ä—Å–æ–Ω–∞–∂), –¥–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞—Å—á–∏—Ç–∞–Ω–Ω–æ–º –∑–∞–¥–∞–Ω–∏–∏
            if (!isRandomCharacter) {
                errorMessage += '<br>–ù–æ —Ç—ã –≤—Å—ë —Ä–∞–≤–Ω–æ –æ—Ç–ª–∏—á–Ω–æ —Å–ø—Ä–∞–≤–∏–ª—Å—è ‚Äî –∑–∞–¥–∞–Ω–∏–µ –∑–∞—Å—á–∏—Ç–∞–Ω–æ!';
            }
            
            msgDiv.innerHTML = `
              <div class="message-bubble">
                <div class="message-text">${errorMessage}</div>
              </div>
            `;
            document.getElementById('chat-container').appendChild(msgDiv);
            scrollChat();
            setTimeout(() => showFinalButtons(character), 800);
            return;
          }
          
          // 4) –ï—Å–ª–∏ —ç—Ç–æ —Ä–∞–Ω–¥–æ–º–Ω—ã–π –≤—ã–±–æ—Ä (–±–µ–∑ AR-—Ü–µ–ª–∏), –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
          // –ù–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –±—ã–ª–æ –æ—à–∏–±–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏
          if (isRandomCharacter && !processingError) {
            setTimeout(() => showFinalButtons(character), 800);
            return;
          }
        }

        function showFinalButtons(character) {
            const controls = document.getElementById('chat-controls');
            if (isRandomCharacter) {
                // –î–ª—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥" –≤–º–µ—Å—Ç–æ "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∫–≤–µ—Å—Ç"
                controls.innerHTML = `
                    <div class="user-response-buttons">
                        <button class="response-btn" onclick="continueToAI('${character}')">üí¨ –ü–æ–æ–±—â–∞—Ç—å—Å—è –¥–∞–ª—å—à–µ</button>
                        <button class="response-btn secondary" onclick="goBack()">‚¨ÖÔ∏è –ù–∞–∑–∞–¥</button>
                    </div>
                `;
            } else {
                // –î–ª—è –æ–±—ã—á–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ (—Å AR-—Ü–µ–ª—å—é) –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫ —Ä–∞–Ω—å—à–µ
                controls.innerHTML = `
                    <div class="user-response-buttons">
                        <button class="response-btn" onclick="continueToAI('${character}')">üí¨ –ü–æ–æ–±—â–∞—Ç—å—Å—è –¥–∞–ª—å—à–µ</button>
                        <button class="response-btn secondary" onclick="continueQuest('${character}')">‚û°Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∫–≤–µ—Å—Ç</button>
                    </div>
                `;
            }
        }

        function continueToAI(character) {
          // ‚úÖ –ó–∞—Å—á–∏—Ç–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–≥–æ, –¥–∞–∂–µ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª ¬´–≥–æ–≤–æ—Ä–∏—Ç—å –¥–∞–ª—å—à–µ¬ª
          // –ù–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ —Å–ª—É—á–∞–π–Ω—ã–π –≤—ã–±–æ—Ä –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
          if (!questState[character].completed && !isRandomCharacter) {
            questState[character].completed = true;

            const el = document.getElementById(`progress-${character}`);
            if (el) {
              el.classList.remove('locked');
              el.classList.add('completed');
              // –ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å .active, –µ—Å–ª–∏ –º–∞—Ä–∫–µ—Ä –≤—Å—ë –µ—â—ë —Ç—Ä–µ–∫–∞–µ—Ç—Å—è ‚Äî —ç—Ç–æ –Ω–µ –º–µ—à–∞–µ—Ç
              // el.classList.remove('active'); // <- —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å —É–±–∏—Ä–∞—Ç—å –ø–æ–¥—Å–≤–µ—Ç–∫—É
            }

            // –ü—Ä–æ–≤–µ—Ä–∏–º, –Ω–µ —Å–æ–±—Ä–∞–Ω—ã –ª–∏ —É–∂–µ –≤—Å–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏
            checkQuestCompletion();
          }

          // –û—Ç–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫ AI-—á–∞—Ç–∞, –∫–∞–∫ –∏ —Ä–∞–Ω—å—à–µ
          document.getElementById('chat-controls').innerHTML = `
            <div class="ai-chat-controls">
              <button class="record-btn idle" id="ai-record-btn" onclick="toggleRecording()">üé§</button>
              <div class="chat-status" id="ai-chat-status">–ù–∞–∂–º–∏ –Ω–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω –¥–ª—è –∑–∞–ø–∏—Å–∏</div>
            </div>
          `;

          // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É –≤—ã—Ö–æ–¥–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è AI-—á–∞—Ç–∞
          document.getElementById('exit-ai-btn').style.display = 'inline-block';
        }

        function continueQuest(character) {
            // –ó–∞—Å—á–∏—Ç–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–≥–æ, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ —Å–ª—É—á–∞–π–Ω—ã–π –≤—ã–±–æ—Ä
            if (!isRandomCharacter) {
                questState[character].completed = true;
                document.getElementById(`progress-${character}`).classList.remove('active');
                document.getElementById(`progress-${character}`).classList.remove('locked');
                document.getElementById(`progress-${character}`).classList.add('completed');
                
                // –ü—Ä–æ–≤–µ—Ä–∏–º, –Ω–µ —Å–æ–±—Ä–∞–Ω—ã –ª–∏ —É–∂–µ –≤—Å–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏
                checkQuestCompletion();
            }
            
            document.getElementById('exit-ai-btn').style.display = 'none';
            document.getElementById('chat-modal').classList.remove('active');
            currentChatCharacter = null;
            processedImage = null;
            photoWaitNoticeShown = false;
            isRandomCharacter = false; // –°–±—Ä–æ—Å–∏—Ç—å —Ñ–ª–∞–≥ —Ä–∞–Ω–¥–æ–º–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞
            isChatOpen = false; // –°–±—Ä–æ—Å–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–∞—Ç–∞
            
            // –í–µ—Ä–Ω—É—Ç—å –≥—Ä–æ–º–∫–æ—Å—Ç—å AR-–º—É–∑—ã–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è —á–∞—Ç–∞
            if (currentArAudio) {
                currentArAudio.volume = isChatOpen ? 0.2 : 1.0;
            }
        }

        function checkQuestCompletion() {
            const allCompleted = Object.values(questState).every(s => s.completed);
            if (allCompleted) {
                setTimeout(() => {
                    document.getElementById('final-modal').classList.add('active');
                }, 800);
            }
        }

        function openCharacterFromProgress(character) {
            if (!questState[character].completed) return;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤—ã—Ö–æ–¥–∞, –∫–∞–∫ —É AI-—á–∞—Ç–∞ –ø–æ—Å–ª–µ –¥–∏–∞–ª–æ–≥–∞
            document.getElementById('exit-ai-btn').style.display = 'inline-block';

            openChatShell(character);
            addCharacterMessage('–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º! –•–æ—á–µ—à—å –µ—â—ë –ø–æ–±–æ–ª—Ç–∞—Ç—å? üòä');
            
            document.getElementById('chat-controls').innerHTML = `
                <div class="ai-chat-controls">
                    <button class="record-btn idle" id="ai-record-btn" onclick="toggleRecording()">üé§</button>
                    <div class="chat-status" id="ai-chat-status">–ù–∞–∂–º–∏ –Ω–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω –¥–ª—è –∑–∞–ø–∏—Å–∏</div>
                </div>
            `;
        }

        let mediaRecorder, audioChunks = [], isRecording = false, isProcessing = false;

        async function toggleRecording() {
            if (isProcessing) return;
            
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    stream.getTracks().forEach(track => track.stop());
                    sendAudioToAI(new Blob(audioChunks, { type: 'audio/webm' }));
                };
                
                mediaRecorder.start();
                isRecording = true;
                
                const btn = document.getElementById('ai-record-btn');
                btn.className = 'record-btn recording';
                btn.textContent = '‚èπÔ∏è';
                document.getElementById('ai-chat-status').textContent = 'üéôÔ∏è –ó–∞–ø–∏—Å—å...';
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:', error);
                document.getElementById('ai-chat-status').textContent = '‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É';
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                isRecording = false;
            }
        }

        async function sendAudioToAI(audioBlob) {
            isProcessing = true;
            const btn = document.getElementById('ai-record-btn');
            btn.className = 'record-btn processing';
            btn.textContent = '‚è≥';
            document.getElementById('ai-chat-status').textContent = 'üîÑ –û–±—Ä–∞–±–æ—Ç–∫–∞...';
            
            try {
                const formData = new FormData();
                formData.append('audio', audioBlob, 'voice.webm');
                formData.append('character', currentChatCharacter);
                formData.append('device_id', SESSION_ID);

                const response = await fetch('/api/chat-stream', { method: 'POST', body: formData });
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        if (!line.trim()) continue;
                        const data = JSON.parse(line);

                        if (data.type === 'stt') {
                            addUserMessage(data.user_text);
                            // Show typing indicator after user message is added
                            showAITypingIndicator();
                        } else if (data.type === 'final') {
                            // Remove typing indicator when character response arrives
                            hideAITypingIndicator();
                            const audioUrl = URL.createObjectURL(base64ToBlob(data.audio_base64, 'audio/mpeg'));
                            addCharacterMessage(data.reply_text, audioUrl);
                            document.getElementById('ai-chat-status').textContent = '‚úÖ –ì–æ—Ç–æ–≤–æ! –ù–∞–∂–º–∏ —Å–Ω–æ–≤–∞';
                        } else if (data.type === 'error') {
                            // Remove typing indicator if there's an error
                            hideAITypingIndicator();
                            addCharacterMessage('–ò–∑–≤–∏–Ω–∏, —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫... üò¢');
                            document.getElementById('ai-chat-status').textContent = '‚ùå –û—à–∏–±–∫–∞';
                        }
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                // Remove typing indicator if there's an error
                hideAITypingIndicator();
                addCharacterMessage('–ò–∑–≤–∏–Ω–∏, —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫... üò¢');
                document.getElementById('ai-chat-status').textContent = '‚ùå –û—à–∏–±–∫–∞';
            } finally {
                isProcessing = false;
                btn.className = 'record-btn idle';
                btn.textContent = 'üé§';
            }
        }

        function base64ToBlob(base64, mimeType) {
            const byteCharacters = atob(base64);
            const byteArrays = [];
            for (let offset = 0; offset < byteCharacters.length; offset += 512) {
                const slice = byteCharacters.slice(offset, offset + 512);
                const byteNumbers = new Array(slice.length);
                for (let i = 0; i < slice.length; i++) byteNumbers[i] = slice.charCodeAt(i);
                byteArrays.push(new Uint8Array(byteNumbers));
            }
            return new Blob(byteArrays, { type: mimeType });
        }

        function openImageViewer(imageSrc) {
            document.getElementById('viewer-image').src = imageSrc;
            document.getElementById('image-viewer').classList.add('active');
        }

        function closeImageViewer() {
            document.getElementById('image-viewer').classList.remove('active');
        }

        function downloadImage() {
            const link = document.createElement('a');
            link.download = `ar-photo-${Date.now()}.png`;
            link.href = document.getElementById('viewer-image').src;
            link.click();
        }

        function scrollChat() {
            const container = document.getElementById('chat-container');
            container.scrollTop = container.scrollHeight;
        }

        function showAITypingIndicator() {
            // Only show typing indicator in AI chat (not in photo chat)
            if (!currentChatCharacter) return;
            
            // Create typing indicator message
            aiTypingIndicator = document.createElement('div');
            aiTypingIndicator.className = 'message character';
            aiTypingIndicator.innerHTML = `
                <div class="message-bubble">
                    <div class="typing-indicator">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            document.getElementById('chat-container').appendChild(aiTypingIndicator);
            scrollChat();
        }

        function hideAITypingIndicator() {
            // Remove typing indicator if it exists
            if (aiTypingIndicator && aiTypingIndicator.parentNode) {
                aiTypingIndicator.parentNode.removeChild(aiTypingIndicator);
                aiTypingIndicator = null;
            }
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('active', show);
        }

        function buyTickets() {
            window.open('https://souzmultpark.ru/?promo=promo1', '_blank');
        }

        function goBack() {
            // –°–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É –≤—ã—Ö–æ–¥–∞
            document.getElementById('exit-ai-btn').style.display = 'none';

            // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É
            document.getElementById('chat-modal').classList.remove('active');

            // –°–±—Ä–æ—Å–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            currentChatCharacter = null;
            processedImage = null;
            photoWaitNoticeShown = false;
            isRandomCharacter = false; // –°–±—Ä–æ—Å–∏—Ç—å —Ñ–ª–∞–≥ —Ä–∞–Ω–¥–æ–º–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞
            isRecording = false;
            isProcessing = false;
            isChatOpen = false; // –°–±—Ä–æ—Å–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–∞—Ç–∞

            // –í–µ—Ä–Ω—É—Ç—å –≥—Ä–æ–º–∫–æ—Å—Ç—å AR-–º—É–∑—ã–∫–∏
            if (currentArAudio) {
                currentArAudio.volume = 1.0;
            }
        }

        function exitAIChat() {
            // –°–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É
            document.getElementById('exit-ai-btn').style.display = 'none';

            // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É
            document.getElementById('chat-modal').classList.remove('active');

            // –°–±—Ä–æ—Å–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            currentChatCharacter = null;
            processedImage = null;
            photoWaitNoticeShown = false;
            isRandomCharacter = false; // –°–±—Ä–æ—Å–∏—Ç—å —Ñ–ª–∞–≥ —Ä–∞–Ω–¥–æ–º–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞
            isRecording = false;
            isProcessing = false;
            isChatOpen = false; // –°–±—Ä–æ—Å–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–∞—Ç–∞

            // –í–µ—Ä–Ω—É—Ç—å –≥—Ä–æ–º–∫–æ—Å—Ç—å AR-–º—É–∑—ã–∫–∏
            if (currentArAudio) {
                currentArAudio.volume = 1.0;
            }
        }

        window.addEventListener('beforeunload', () => {
          for (const url of audioCache.values()) URL.revokeObjectURL(url);
        });
    </script>
</body>
</html>