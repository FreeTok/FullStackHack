<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script src="./assets/aframe.min.js"></script>
    <script src="./assets/mindar-image-aframe.prod.js"></script>
    <script src="./assets/aframe-extras.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;600;700&display=swap');

        :root {
            --primary-color: #d9a05c; /* A warm, vintage orange/brown */
            --secondary-color: #5c85d9; /* A muted blue */
            --accent-color: #f2e8c9; /* A creamy, paper-like color */
            --text-color: #4a3f35; /* Dark brown for text */
            --white-color: #f7f5f2;
            --success-color: #7aa35b; /* A gentle green */
            --disabled-color: #9e9e9e;
        }

        * {
            margin: 0; padding: 0; box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Comfortaa', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            overflow: hidden; position: fixed; width: 100%; height: 100%; 
            background-color: var(--accent-color);
        }

        /* Стартовое модальное окно */
        .intro-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            z-index: 6000; display: flex; align-items: center; justify-content: center;
            padding: 20px;
        }
                
        .intro-modal.hidden { display: none; }
        
        .intro-content {
            background: var(--accent-color);
            border: 6px solid var(--primary-color);
            border-radius: 20px; 
            padding: 35px 25px;
            max-width: 450px; 
            width: 100%; 
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
                                
        .intro-content h1 {
            font-size: 28px; 
            color: var(--primary-color); 
            margin-bottom: 20px;
            font-weight: 700;
            letter-spacing: 1px;
        }
        
        .intro-content .story {
            font-size: 15px; 
            line-height: 1.7; 
            color: var(--text-color);
            margin-bottom: 25px; 
            text-align: left;
            background: rgba(217, 160, 92, 0.1);
            padding: 15px;
            border-radius: 15px;
            border-left: 4px solid var(--primary-color);
        }
        
        .intro-content .story p strong {
            color: var(--primary-color);
        }
        
        .intro-content .characters-preview {
            display: flex; 
            justify-content: center; 
            gap: 10px;
            margin: 25px 0; 
            flex-wrap: wrap;
        }
        
        .character-icon-preview {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.5);
            border: 3px solid var(--primary-color);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .character-icon-preview img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
                
        .start-quest-btn {
            background-color: var(--primary-color);
            color: var(--white-color); 
            border: none;
            border-radius: 50px;
            padding: 18px 45px; 
            font-size: 19px; 
            font-weight: 700;
            cursor: pointer; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: all 0.2s;
            letter-spacing: 1px;
        }
        
        .start-quest-btn:active { 
            transform: scale(0.95) translateY(2px); 
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        /* Верхняя панель прогресса */
        .progress-bar {
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            z-index: 1000;
            /* Убран фон, как и просили */
            background: none; 
            padding: max(env(safe-area-inset-top), 12px) 10px 12px 10px;
            display: flex; 
            justify-content: space-around; 
            align-items: center;
            pointer-events: auto;
        }
        
        .character-progress {
            display: flex; 
            flex-direction: column; 
            align-items: center;
            cursor: pointer; 
            transition: all 0.3s;
            padding: 5px;
        }
        
        .character-progress.locked {
            opacity: 0.6; 
            cursor: not-allowed;
            filter: grayscale(0.8);
        }
        
        .character-progress.completed {
            opacity: 1;
        }
        
        .character-progress.completed .progress-icon {
            background: var(--success-color);
            box-shadow: 0 0 15px rgba(122, 163, 91, 0.5);
            border-color: var(--accent-color);
        }
        
        .progress-icon {
            width: 64px; 
            height: 64px; 
            border-radius: 50%;
            background: rgba(0,0,0,0.3);
            display: flex; 
            align-items: center; 
            justify-content: center;
            font-size: 36px; 
            margin-bottom: 5px;
            border: 4px solid rgba(255,255,255,0.4);
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        .character-progress.active .progress-icon {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(242, 232, 201, 0.9); 
            border-color: var(--accent-color);
        }
                
        .progress-name {
            font-size: 11px; 
            color: white; 
            font-weight: 700;
            background-color: rgba(0,0,0,0.4);
            padding: 2px 8px;
            border-radius: 10px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            letter-spacing: 0.5px;
        }

        /* Кнопка фото */
        .controls-bar {
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            z-index: 1000;
            background: none; /* Убран фон */
            padding: 25px 20px calc(max(env(safe-area-inset-bottom), 20px) + 25px) 20px;
            display: flex; 
            justify-content: center; 
            align-items: center;
            pointer-events: auto;
        }
        
        .photo-btn {
            width: 80px; 
            height: 80px; 
            border-radius: 50%; 
            background: var(--white-color);
            border: 6px solid var(--primary-color); 
            cursor: pointer;
            transition: all 0.2s; 
            position: relative; 
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .photo-btn:active { 
            transform: scale(0.9); 
            box-shadow: 0 3px 15px rgba(0,0,0,0.3);
        }
        
        .photo-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 42px;
        }
        
        .photo-btn.disabled {
            opacity: 0.6; 
            cursor: not-allowed;
            filter: grayscale(0.8);
        }

        /* Модальное окно чата */
        .chat-modal {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: rgba(42, 36, 30, 0.85); 
            z-index: 5000;
            display: none; 
            align-items: center; 
            justify-content: center;
            backdrop-filter: blur(8px);
        }
        
        .chat-modal.active { display: flex; }
        
        .chat-content {
            width: 100%; 
            max-width: 500px; 
            height: 92%;
            background: var(--accent-color);
            border-radius: 20px;
            padding: 20px; 
            display: flex; 
            flex-direction: column;
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            border: 5px solid var(--primary-color);
            margin: 20px;
        }
        
        .chat-header {
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            margin-bottom: 15px; 
            padding-bottom: 12px; 
            border-bottom: 3px solid var(--primary-color);
        }
        
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-title-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chat-header h1 {
            font-size: 24px;
            color: var(--primary-color);
            font-weight: 700;
            margin: 0;
        }
        
        #chat-character-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.5);
            border: 2px solid var(--primary-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        #chat-character-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .chat-container {
            flex-grow: 1; 
            overflow-y: auto; 
            padding: 15px;
            background: rgba(255,255,255,0.6); 
            border-radius: 15px; 
            margin-bottom: 15px;
            border: 2px solid rgba(217, 160, 92, 0.3);
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) var(--accent-color);
        }
        
        .chat-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .chat-container::-webkit-scrollbar-track {
            background: var(--accent-color);
            border-radius: 10px;
        }
        
        .chat-container::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 10px;
        }
        
        .message {
            margin-bottom: 18px; 
            animation: messageSlideIn 0.4s ease-out;
        }
        
        @keyframes messageSlideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.character {
            display: flex; 
            flex-direction: column; 
            align-items: flex-start;
        }
        
        .message.user {
            display: flex; 
            flex-direction: column; 
            align-items: flex-end;
        }
        
        .message-bubble {
            background: var(--white-color);
            padding: 14px 18px;
            border-radius: 20px 20px 20px 5px; 
            max-width: 80%;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
            border: 2px solid rgba(217, 160, 92, 0.4);
            position: relative;
        }
        
        .message.user .message-bubble {
            background: var(--secondary-color);
            border-radius: 20px 20px 5px 20px;
            border-color: transparent;
        }
        
        .message-text {
            font-size: 15px; 
            line-height: 1.5; 
            color: var(--text-color);
            font-weight: 500;
        }

        .message.user .message-text {
            color: var(--white-color);
        }
        
        .message-image {
            max-width: 100%; 
            border-radius: 15px; 
            margin-top: 12px;
            cursor: pointer; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border: 3px solid white;
            transition: transform 0.2s;
        }
        
        .message-image:active {
            transform: scale(0.98);
        }
        
        .message audio {
            width: 100%; 
            margin-top: 12px; 
            border-radius: 12px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.15));
        }

        /* Кнопки ответа пользователя */
        .user-response-buttons {
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
            padding: 10px 0;
        }
        
        .response-btn {
            background: var(--secondary-color); 
            color: var(--white-color); 
            border: none;
            padding: 16px 22px; 
            border-radius: 15px;
            font-size: 16px; 
            cursor: pointer; 
            text-align: center;
            transition: all 0.2s; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            font-weight: 700;
        }
        
        .response-btn:active { 
            transform: scale(0.97) translateY(2px); 
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .response-btn.secondary {
            background: var(--disabled-color);
        }

        /* AI чат */
        .ai-chat-controls {
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
            align-items: center;
        }
        
        .record-btn {
            width: 76px; 
            height: 76px; 
            border-radius: 50%; 
            border: 4px solid var(--white-color);
            font-size: 38px; 
            cursor: pointer; 
            transition: all 0.3s;
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }
        
        .record-btn.idle { 
            background: var(--primary-color);
        }
        
        .record-btn.recording { 
            background: #e74c3c; /* A classic red for recording */
            transform: scale(1.1);
        }
        
        .record-btn.processing { 
            background: var(--disabled-color); 
            cursor: not-allowed; 
        }
                
        .chat-status {
            font-size: 14px;
            color: var(--text-color);
            text-align: center;
            font-weight: 600;
            background: rgba(217, 160, 92, 0.2);
            padding: 8px 16px;
            border-radius: 15px;
        }
        
        .typing-indicator {
            display: inline-flex;
            align-items: center;
            padding: 8px 15px;
            background: var(--white-color);
            border-radius: 20px 5px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
            border: 2px solid rgba(217, 160, 92, 0.4);
        }
        
        .typing-indicator span {
            height: 8px;
            width: 8px;
            background: var(--text-color);
            border-radius: 50%;
            display: inline-block;
            margin: 0 2px;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }

        /* Модальное окно просмотра фото */
        .image-viewer-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); 
            z-index: 6000; display: none; 
            align-items: center; justify-content: center;
            flex-direction: column; padding: 20px;
        }
        
        .image-viewer-modal.active { display: flex; }
        
        .viewer-image {
            max-width: 90%; max-height: 70vh; border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); margin-bottom: 25px;
            border: 5px solid var(--accent-color);
        }
        
        .viewer-actions { display: flex; gap: 15px; }
        
        .viewer-btn {
            padding: 14px 28px; border-radius: 30px; 
            border: 3px solid var(--white-color); font-size: 17px; 
            font-weight: 700; cursor: pointer; transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .viewer-btn.download { background: var(--success-color); color: #fff; }
        .viewer-btn.close { background: var(--disabled-color); color: #fff; }
        .viewer-btn:active { transform: scale(0.95); }

        /* Финальное модальное окно */
        .final-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            z-index: 7000; display: none; align-items: center; justify-content: center;
            padding: 20px;
        }
        
        .final-modal.active { display: flex; }
        
        .final-content {
            background: var(--accent-color); 
            border: 6px solid var(--primary-color);
            border-radius: 20px; padding: 40px 30px;
            max-width: 500px; width: 100%; text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            position: relative;
        }
        
        .final-content::before,
        .final-content::after {
            content: '🎉'; position: absolute; font-size: 40px;
        }
        
        .final-content::before { top: -20px; left: 20px; transform: rotate(-15deg); }
        .final-content::after { top: -20px; right: 20px; transform: rotate(15deg); }
        
        .final-content h1 {
            font-size: 34px; color: var(--primary-color); 
            margin-bottom: 20px; font-weight: 700;
        }
        
        .final-content .promo-code {
            background: var(--success-color);
            color: var(--white-color);
            font-size: 32px;
            font-weight: 700;
            padding: 22px;
            border-radius: 15px;
            margin: 28px auto;      /* центрирование по горизонтали */
            letter-spacing: 4px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
            border: 4px solid var(--white-color);
            display: inline-block;  /* чтобы margin:auto сработал */
            text-align: center;     /* выравнивание текста внутри */
        }
        
        .tickets-btn {
            background: var(--primary-color); 
            color: var(--white-color); 
            border: none;
            padding: 18px 45px; 
            border-radius: 50px; 
            font-size: 19px;
            font-weight: 700; cursor: pointer; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }
        
        .tickets-btn:active {
            transform: scale(0.95) translateY(3px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .loading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(42, 36, 30, 0.9); 
            z-index: 8000;
            display: none; flex-direction: column; 
            align-items: center; justify-content: center; 
            gap: 25px;
        }
        
        .loading.active { display: flex; }
        
        .spinner {
            width: 60px; height: 60px; 
            border: 5px solid var(--accent-color);
            border-top-color: var(--primary-color); 
            border-radius: 50%; 
            animation: spin 1s linear infinite;
        }

        .progress-icon {
        position: relative;
        width: 64px;
        height: 64px;
        border-radius: 50%;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        }

        .progress-icon img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        position: absolute;
        top: 0;
        left: 0;
        transition: opacity 0.3s;
        }

        .buy-tickets-ar-btn {
            position: absolute;
            bottom: calc(env(safe-area-inset-bottom) + 4px); /* было +120px */
            background: linear-gradient(135deg, #d9a05c, #e7b874);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 10px 20px; /* уменьшена высота кнопки */
            font-size: 14px;    /* уменьшен размер шрифта */
            font-weight: 700;
            box-shadow: 0 6px 15px rgba(0,0,0,0.25);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .buy-tickets-ar-btn:active {
            transform: scale(0.96) translateY(3px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.25);
        }

        /* По умолчанию видна обычная иконка */
        .progress-icon .icon-default { opacity: 1; }
        .progress-icon .icon-filled { opacity: 0; }

        /* Для активных или завершённых — показываем "заполненную" */
        .character-progress.active .icon-default,
        .character-progress.completed .icon-default { opacity: 0; }

        .character-progress.active .icon-filled,
        .character-progress.completed .icon-filled { opacity: 1; }

        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .loading-text {
            color: var(--white-color);
            font-size: 18px;
            font-weight: 700;
        }
        
        /* Адаптивность для мобильных устройств */
        @media (max-width: 480px) {
            .intro-content {
                padding: 20px 15px;
                border-width: 4px;
                max-height: 85vh;
            }
            
            .intro-content h1 {
                font-size: 22px;
                margin-bottom: 15px;
            }
            
            .intro-content .story {
                font-size: 13px;
                padding: 12px;
                margin-bottom: 15px;
            }
            
            .intro-content .characters-preview {
                gap: 8px;
                margin: 15px 0;
            }
            
            .character-icon-preview {
                width: 50px;
                height: 50px;
            }
            
            .start-quest-btn {
                padding: 14px 30px;
                font-size: 16px;
            }
        }
        
        @media (max-height: 700px) {
            .intro-content {
                padding: 15px;
            }
            
            .intro-content h1 {
                font-size: 20px;
                margin-bottom: 10px;
            }
            
            .intro-content .story {
                font-size: 12px;
                padding: 10px;
                margin-bottom: 12px;
            }
            
            .character-icon-preview {
                width: 45px;
                height: 45px;
            }
        }
        
        /* Адаптация для конкретных моделей iPhone */
        @media screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) { /* iPhone 6/7/8 */
            .intro-content {
                max-height: 75vh;
                padding: 15px 10px;
            }
            
            .intro-content h1 {
                font-size: 19px;
            }
            
            .intro-content .story {
                font-size: 11px;
                padding: 8px;
                line-height: 1.5;
            }
            
            .character-icon-preview {
                width: 40px;
                height: 40px;
            }
            
            .start-quest-btn {
                padding: 12px 20px;
                font-size: 15px;
            }
        }
        
        @media screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) { /* iPhone X, 11 Pro */
            .intro-content {
                max-height: 80vh;
                padding: 20px 12px;
            }
            
            .intro-content h1 {
                font-size: 22px;
            }
            
            .intro-content .story {
                font-size: 13px;
                line-height: 1.5;
                padding: 10px;
            }
        }
        
        @media screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) { /* iPhone XR, 11 */
            .intro-content {
                max-height: 78vh;
                padding: 20px 12px;
            }
        }
        
        /* Оптимизированная адаптация стартового экрана с учетом работы AR камеры */
        @media (max-width: 480px) and (max-height: 700px) {
            .intro-content {
                padding: 20px 15px;
                max-height: 82vh;
            }
            
            .intro-content h1 {
                font-size: 22px;
                margin-bottom: 12px;
            }
            
            .intro-content .story {
                font-size: 12px;
                padding: 10px;
                margin-bottom: 15px;
                line-height: 1.5;
            }
            
            .intro-content .characters-preview {
                gap: 8px;
                margin: 15px 0;
            }
            
            .character-icon-preview {
                width: 50px;
                height: 50px;
            }
            
            .start-quest-btn {
                padding: 14px 25px;
                font-size: 16px;
            }
        }
        
        /* Адаптация для iPhone X/XS/11 Pro (375x812) */
        @media screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) {
            .intro-content {
                padding: 22px 16px;
                max-height: 80vh;
            }
            
            .intro-content h1 {
                font-size: 23px;
            }
            
            .intro-content .story {
                font-size: 13px;
                padding: 12px;
            }
        }
        
        /* Адаптация для iPhone 6/7/8 (375x667) */
        @media screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) {
            .intro-content {
                padding: 18px 14px;
                max-height: 82vh;
            }
            
            .intro-content h1 {
                font-size: 21px;
            }
            
            .intro-content .story {
                font-size: 12px;
                padding: 10px;
            }
        }
        
        /* Адаптация для iPhone XR/11 (414x896) */
        @media screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) {
            .intro-content {
                padding: 24px 18px;
                max-height: 80vh;
            }
        }
    </style>
</head>
<body>
    <canvas id="capture-canvas" style="display: none;"></canvas>

    <a-scene id="ar-scene" 
      mindar-image="imageTargetSrc: ./assets/targets_all.mind; maxTrack: 1; autoStart: true; uiLoading: no; uiError: no; uiScanning: no; filterMinCF:0.0001; filterBeta: 0.01"
      color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights, antialias: true, alpha: true" 
      vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false" embedded>

        <a-assets>
            <a-asset-item id="zayac" src="./assets/zayac.glb"></a-asset-item>
            <a-asset-item id="cheb" src="./assets/oranges.glb"></a-asset-item>
            <a-asset-item id="gena" src="./assets/sign.glb"></a-asset-item>
            <a-asset-item id="shap" src="./assets/case.glb"></a-asset-item>
            <audio id="target-cheb-audio" src="./assets/cheba-song.mp3" preload="auto" loop></audio>
            <audio id="target-volc-audio" src="./assets/volc-song.mp3" preload="auto" loop></audio>
            <audio id="target-gena-audio" src="./assets/gena-song.mp3" preload="auto" loop></audio>
            <audio id="target-shap-audio" src="./assets/shap-song.mp3" preload="auto" loop></audio>
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false" cursor="rayOrigin: mouse"></a-camera>

        <a-entity id="target-cheb" mindar-image-target="targetIndex: 0">
          <a-gltf-model rotation="0 -90 -20" position="0 -1 -1" scale="0.5 0.5 0.5" src="#cheb" animation-mixer="clip: *; loop: repeat;"></a-gltf-model>
        </a-entity>
        <a-entity id="target-volc" mindar-image-target="targetIndex: 1">
          <a-gltf-model rotation="0 0 0" position="-0.5 -1 -1" scale="0.5 0.5 0.5" src="#zayac" animation-mixer="clip: *; loop: repeat;"></a-gltf-model>
        </a-entity>
        <a-entity id="target-gena" mindar-image-target="targetIndex: 2">
            <a-gltf-model rotation="0 270 -20" position="-1 -2 -2" scale="1 1 1" src="#gena"></a-gltf-model>
        </a-entity>
        <a-entity id="target-shap" mindar-image-target="targetIndex: 3">
            <a-gltf-model rotation="0 225 0" position="-0.5 -1 -1" scale="1 1 1" src="#shap"></a-gltf-model>
        </a-entity>
        <a-entity id="target-cheb-night" mindar-image-target="targetIndex: 4">
          <a-gltf-model rotation="0 -90 -20" position="0 -1 -1" scale="0.5 0.5 0.5" src="#cheb" animation-mixer="clip: *; loop: repeat;"></a-gltf-model>
        </a-entity>
        <a-entity id="target-volc-night" mindar-image-target="targetIndex: 5">
          <a-gltf-model rotation="0 0 0" position="-0.5 -1 -1" scale="0.5 0.5 0.5" src="#zayac" animation-mixer="clip: *; loop: repeat;"></a-gltf-model>
        </a-entity>
        <a-entity id="target-gena-night" mindar-image-target="targetIndex: 6">
            <a-gltf-model rotation="0 270 -20" position="-1 -2 -2" scale="1 1 1" src="#gena"></a-gltf-model>
        </a-entity>
        <a-entity id="target-shap-night" mindar-image-target="targetIndex: 7">
            <a-gltf-model rotation="0 225 0" position="-0.5 -1 -1" scale="1 1 1" src="#shap"></a-gltf-model>
        </a-entity>        
    </a-scene>

    <div class="intro-modal" id="intro-modal">
        <div class="intro-content">
            <h1>🎭 Добро пожаловать!</h1>
            <div class="story">
                <p><strong>Твоя миссия:</strong> Найди всех четырех легендарных персонажей советских мультфильмов!</p>
                <br>
                <p>Каждый из них приготовил для тебя особое задание. Подойди к статуе, сфотографируйся с персонажем в AR и пообщайся с ним!</p>
                <br>
                <p>После выполнения всех заданий тебя ждёт <strong>секретный промокод</strong> на билеты в парк! 🎫</p>
            </div>
            <div class="characters-preview">
                <div class="character-icon-preview">
                    <img src="./assets/icons/cheb.png" alt="Чебурашка">
                </div>
                <div class="character-icon-preview">
                    <img src="./assets/icons/gena.png" alt="Крокодил Гена">
                </div>
                <div class="character-icon-preview">
                    <img src="./assets/icons/shap.png" alt="Шапокляк">
                </div>
                <div class="character-icon-preview">
                    <img src="./assets/icons/volc.png" alt="Волк">
                </div>
            </div>
            <button class="start-quest-btn" onclick="startQuest()">Начать квест!</button>
        </div>
    </div>

    <div class="progress-bar" id="progress-bar" style="display: none;">
        <div class="character-progress locked" id="progress-cheb" onclick="openCharacterFromProgress('cheb')">
            <div class="progress-icon">
                <img src="./assets/icons/cheb_0.png" class="icon-default">
                <img src="./assets/icons/cheb.png" class="icon-filled">
            </div>
            <div class="progress-name">Чебурашка</div>
        </div>
        <div class="character-progress locked" id="progress-gena" onclick="openCharacterFromProgress('gena')">
            <div class="progress-icon">
                <img src="./assets/icons/gena_0.png" class="icon-default">
                <img src="./assets/icons/gena.png" class="icon-filled">
            </div>
            <div class="progress-name">Гена</div>
        </div>
        <div class="character-progress locked" id="progress-shap" onclick="openCharacterFromProgress('shap')">
            <div class="progress-icon">
                <img src="./assets/icons/shap_0.png" class="icon-default">
                <img src="./assets/icons/shap.png" class="icon-filled">
            </div>
            <div class="progress-name">Шапокляк</div>
        </div>
        <div class="character-progress locked" id="progress-volc" onclick="openCharacterFromProgress('volc')">
            <div class="progress-icon">
                <img src="./assets/icons/volc_0.png" class="icon-default">
                <img src="./assets/icons/volc.png" class="icon-filled">
            </div>
            <div class="progress-name">Волк</div>
        </div>
    </div>

    <div class="controls-bar" id="controls-bar" style="display: none;">
        <button class="photo-btn" id="photo-btn" onclick="takePhoto()"></button>
        <button class="buy-tickets-ar-btn" onclick="buyTickets()">Купить билеты в СоюзМультПарк</button>
    </div>

    <div class="chat-modal" id="chat-modal">
        <div class="chat-content">
            <div class="chat-header">
              <div class="chat-title-container">
                <span id="chat-character-icon"></span>
                <h1 id="chat-title">Чат</h1>
              </div>
              <button id="exit-ai-btn" onclick="exitAIChat()" style="
                  display: none;
                  background: var(--disabled-color);
                  color: white; border: none;
                  border-radius: 12px; padding: 8px 14px;
                  font-size: 14px; font-weight: 700;
                  cursor: pointer; box-shadow: 0 3px 8px rgba(0,0,0,0.2);
              ">🚪 Выйти</button>
            </div>
            <div class="chat-container" id="chat-container"></div>
            <div id="chat-controls"></div>
        </div>
    </div>

    <div class="image-viewer-modal" id="image-viewer">
        <img id="viewer-image" class="viewer-image" alt="Фото">
        <div class="viewer-actions">
            <button class="viewer-btn download" onclick="downloadImage()">💾 Скачать</button>
            <button class="viewer-btn close" onclick="closeImageViewer()">✖ Закрыть</button>
        </div>
    </div>

    <div class="final-modal" id="final-modal">
        <div class="final-content">
            <h1>🎉 Поздравляем!</h1>
            <p style="font-size: 18px; margin: 20px 0; color: var(--text-color); font-weight: 600;">Ты прошёл весь квест и познакомился со всеми персонажами!</p>
            <div class="promo-code" id="promo-code">PROMO2025</div>
            <p style="font-size: 14px; color: #7f8c8d; margin-bottom: 25px; font-weight: 600;">Используй этот промокод при покупке билетов</p>
            <button class="tickets-btn" onclick="buyTickets()">🎫 Купить билеты</button>
        </div>
    </div>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div class="loading-text">Обработка...</div>
    </div>

    <script>
        // Глобальные переменные
        const SESSION_ID = 'session-' + Math.random().toString(36).substr(2, 9);
        let currentlyPlayingAudio = null; // Для голоса персонажа
        let currentArAudio = null; // Для AR-музыки
        let isChatOpen = false; // Состояние чата
        let activeCharacter = null;
        let currentChatCharacter = null;
        let processedImage = null;
        let photoWaitNoticeShown = false;
        let processingDone = false;     // обработка завершилась (успех или ошибка)
        let processingError = false;    // обработка завершилась ошибкой
        let questState = {
            cheb: { completed: false, photo: null },
            gena: { completed: false, photo: null },
            shap: { completed: false, photo: null },
            volc: { completed: false, photo: null }
        };
        let aiTypingIndicator = null; // Для индикатора печати ИИ
        const audioCache = new Map();

        const characterData = {
            cheb: {
                name: "Чебурашка",
                emoji: "🐭",
                dialog: [
                    { type: 'character', text: 'Привет! Сейчас сфотографирую... ⏳', audio: './assets/dialogues/cheb-1.mp3' },
                    { type: 'user', text: 'Привет, Чебурашка!' },
                    { type: 'character', text: 'Я раньше в ящике с апельсинами жил. А теперь у меня свой домик есть!', audio: './assets/dialogues/cheb-2.mp3' },
                    { type: 'user', text: 'Какой домик?' },
                    { type: 'character', text: 'В СоюзМультПарке! Там видео с фильтрами снимать можно, героев оживлять, с Винни-Пухом мёд искать!', audio: './assets/dialogues/cheb-3.mp3' },
                    { type: 'user', text: 'Интересно!' },
                    { type: 'character', text: 'Фото готово! 📸 Приходи в гости, будет весело! 😊 Билеты на <a href="https://souzmultpark.ru" target="_blank">souzmultpark.ru</a>', audio: './assets/dialogues/cheb-4.mp3' },
                ]
            },
            gena: {
                name: "Крокодил Гена",
                emoji: "🐊",
                dialog: [
                    { type: 'character', text: 'Здравствуйте! Сейчас сделаю ваше фото... ⏳', audio: './assets/dialogues/gena-1.mp3' },
                    { type: 'user', text: 'Привет, Гена!' },
                    { type: 'character', text: 'Раньше я в зоопарке работал крокодилом. Скучно было! А сейчас столько технологий вокруг...', audio: './assets/dialogues/gena-2.mp3' },
                    { type: 'user', text: 'А что изменилось?' },
                    { type: 'character', text: 'В СоюзМультПарке можно в VR мультфильм нарисовать, на дирижабле полетать, в купольном кинотеатре полежать. 18 аттракционов!', audio: './assets/dialogues/gena-3.mp3' },
                    { type: 'user', text: 'Круто!' },
                    { type: 'character', text: 'Фото готово! 📸 Если интересно — билеты на <a href="https://souzmultpark.ru" target="_blank">souzmultpark.ru</a>', audio: './assets/dialogues/gena-4.mp3' },
                ]
            },
            shap: {
                name: "Шапокляк",
                emoji: "👵",
                dialog: [
                    { type: 'character', text: 'Лариска, фотографируй! ⏳', audio: './assets/dialogues/shap-1.mp3' },
                    { type: 'user', text: 'Здравствуйте!' },
                    { type: 'character', text: 'Раньше мы с Лариской по городу пакости делали. Скучно было!', audio: './assets/dialogues/shap-2.mp3' },
                    { type: 'user', text: 'И как теперь?' },
                    { type: 'character', text: 'В СоюзМультПарке можно в тире стрелять, на корабле Пегас летать, по крышам с Карлсоном прыгать! Лариска в восторге.', audio: './assets/dialogues/shap-3.mp3' },
                    { type: 'user', text: 'Молодцы!' },
                    { type: 'character', text: 'Готово! 📸 Заходи, если не боишься приключений! 😏 <a href="https://souzmultpark.ru" target="_blank">souzmultpark.ru</a>', audio: './assets/dialogues/shap-4.mp3' },
                ]
            },
            volc: {
                name: "Волк",
                emoji: "🐺",
                dialog: [
                    { type: 'character', text: 'Щас запечатлею... ⏳', audio: './assets/dialogues/volc-1.mp3' },
                    { type: 'user', text: 'Привет, Волк!' },
                    { type: 'character', text: 'Я Зайца гонял всю жизнь. Устал уже! А тут узнал — в парке нас обоих на экране можно увидеть.', audio: './assets/dialogues/volc-2.mp3' },
                    { type: 'user', text: 'Как это?' },
                    { type: 'character', text: 'Раскрашиваешь — и мы оживаем! Плюс VR, джунгли с Маугли, трон в Тридевятом царстве. 18 аттракционов.', audio: './assets/dialogues/volc-3.mp3' },
                    { type: 'user', text: 'Прикольно!' },
                    { type: 'character', text: 'Держи фото! 📸 Билеты на <a href="https://souzmultpark.ru" target="_blank">souzmultpark.ru</a>. Побежал! 😎', audio: './assets/dialogues/volc-4.mp3' },
                ]
            }
        };

        async function preloadDialogAudios() {
          const urls = [...new Set(
            Object.values(characterData)
              .flatMap(c => c.dialog.filter(m => m.audio).map(m => m.audio))
          )];

          await Promise.all(urls.map(async (url) => {
            if (audioCache.has(url)) return;
            const res = await fetch(url, { cache: 'force-cache' });
            const buf = await res.arrayBuffer();
            const blob = new Blob([buf], { type: 'audio/mpeg' });
            const objectUrl = URL.createObjectURL(blob);
            audioCache.set(url, objectUrl);
          }));
        }

        window.addEventListener('load', () => {
          preloadDialogAudios().catch(console.warn);
        });


        // Старт квеста
        function startQuest() {
            // Инициализация аудио-контекста для разрешения воспроизведения звука на iOS
            const audios = [
                document.getElementById('target-cheb-audio'),
                document.getElementById('target-volc-audio'),
                document.getElementById('target-gena-audio'),
                document.getElementById('target-shap-audio')
            ];
        
            for (const audio of audios) {
                try {
                    // Инициализируем аудио контекст, но НЕ запускаем воспроизведение
                    audio.load();
                } catch (e) {
                    console.warn('Audio init failed', e);
                }
            }
        
            document.getElementById('intro-modal').classList.add('hidden');
            document.getElementById('progress-bar').style.display = 'flex';
            document.getElementById('controls-bar').style.display = 'flex';
        }

        // AR логика
        document.addEventListener('DOMContentLoaded', () => {
            const sceneEl = document.querySelector('a-scene');
            const targets = [
              { 
                  id: "cheb", 
                  entities: [
                      document.querySelector('#target-cheb'),
                      document.querySelector('#target-cheb-night')
                  ], 
                  audio: document.getElementById('target-cheb-audio') 
              },
              { 
                  id: "volc", 
                  entities: [
                      document.querySelector('#target-volc'),
                      document.querySelector('#target-volc-night')
                  ], 
                  audio: document.getElementById('target-volc-audio') 
              },
              { 
                  id: "gena", 
                  entities: [
                      document.querySelector('#target-gena'),
                      document.querySelector('#target-gena-night')
                  ], 
                  audio: document.getElementById('target-gena-audio') 
              },
              { 
                  id: "shap", 
                  entities: [
                      document.querySelector('#target-shap'),
                      document.querySelector('#target-shap-night')
                  ], 
                  audio: document.getElementById('target-shap-audio') 
              },
          ];

          targets.forEach(target => {
              target.entities.forEach(entity => {
                  if (!entity) return; // Пропустить, если entity не найден
                  
                  entity.addEventListener('targetFound', () => {
                      activeCharacter = target.id;
                      document.getElementById(`progress-${target.id}`).classList.add('active');
                      
                      if (target.audio) {
                          target.audio.volume = isChatOpen ? 0.2 : 1.0;
                          target.audio.play().catch(e => console.warn("Audio play failed:", e));
                          currentArAudio = target.audio;
                      }
                  });

                  entity.addEventListener('targetLost', () => {
                      activeCharacter = null;
                      document.getElementById(`progress-${target.id}`).classList.remove('active');
                      
                      if (currentArAudio === target.audio) {
                          currentArAudio.pause();
                          currentArAudio = null;
                      }
                  });
              });
          });
        });

        let isRandomCharacter = false; // Глобальная переменная для отслеживания рандомного выбора

        function openChatShell(character, random = false) {
            currentChatCharacter = character;
            isRandomCharacter = random;
            photoWaitNoticeShown = false;
            isChatOpen = true; // Установить состояние чата

            const data = characterData[character];
            document.getElementById('chat-title').textContent = data.name;
            document.getElementById('chat-character-icon').innerHTML = `<img src="./assets/icons/${character}.png" alt="${data.name}">`;
            document.getElementById('chat-modal').classList.add('active');
            document.getElementById('chat-container').innerHTML = '';
            document.getElementById('chat-controls').innerHTML = '';
            
            // Уменьшить громкость AR-музыки при открытии чата
            if (currentArAudio) {
                currentArAudio.volume = 0.2;
            }
        }

        function startScriptedDialog(character) {
            const data = characterData[character];
            let currentStep = 0;

            function showNextMessage() {
                if (currentStep >= data.dialog.length) {
                    setTimeout(() => {
                        showProcessedPhoto(character);
                    }, 800);
                    return;
                }

                const message = data.dialog[currentStep];
                if (message.type === 'character') {
                    addCharacterMessage(message.text, message.audio);
                    currentStep++;

                    if (currentStep < data.dialog.length) {
                        const nextMsg = data.dialog[currentStep];
                        if (nextMsg.type === 'user') {
                            // Добавить задержку в полсекунды перед показом кнопки ответа пользователя
                            setTimeout(() => {
                                showResponseButton(nextMsg.text, showNextMessage);
                            }, 500);
                        } else {
                            setTimeout(showNextMessage, message.audio ? 2000 : 1000);
                        }
                    } else {
                        setTimeout(showNextMessage, 800);
                    }
                } else if (message.type === 'user') {
                    currentStep++;
                    // Добавить задержку в полсекунду перед следующим сообщением персонажа
                    setTimeout(showNextMessage, 500);
                }
            }

            showNextMessage();
        }

        async function takePhoto() {
            let characterToUse = activeCharacter;
            
            // Если нет активного персонажа (AR-цели), выбираем случайного
            if (!activeCharacter) {
                const characters = ['cheb', 'gena', 'shap', 'volc'];
                characterToUse = characters[Math.floor(Math.random() * characters.length)];
            } else {
                // Для активного персонажа сбрасываем флаг completed, чтобы можно было снова с ним взаимодействовать
                // Но оставляем фото, если оно уже было сделано
                if (questState[activeCharacter].completed) {
                    // Не сбрасываем completed, чтобы не терять прогресс, но разрешаем взаимодействие
                }
            }

            const sceneEl = document.querySelector('#ar-scene');
            const video = sceneEl.systems["mindar-image-system"].video;
            
            // Если есть видео, делаем фото с AR-наложением, иначе просто фото
            let photoCanvas, arCanvas;
            if (video && video.videoWidth) {
                photoCanvas = document.createElement('canvas');
                photoCanvas.width = video.videoWidth;
                photoCanvas.height = video.videoHeight;
                photoCanvas.getContext('2d').drawImage(video, 0, 0);

                // Если есть активный персонаж, используем AR-канвас, иначе отправляем без AR-слоя
                if (activeCharacter) {
                    arCanvas = sceneEl.canvas;
                } else {
                    // Для случайного выбора создаем пустой AR-канвас (без AR-слоя)
                    arCanvas = document.createElement('canvas');
                    arCanvas.width = photoCanvas.width;
                    arCanvas.height = photoCanvas.height;
                    // Заполняем прозрачным, чтобы сервер знал, что AR-слоя нет
                    arCanvas.getContext('2d').clearRect(0, 0, arCanvas.width, arCanvas.height);
                }
            } else {
                // Если нет AR-видео, создаем пустой canvas
                photoCanvas = document.createElement('canvas');
                photoCanvas.width = 640;
                photoCanvas.height = 480;
                photoCanvas.getContext('2d').fillStyle = '#ffffff';
                photoCanvas.getContext('2d').fillRect(0, 0, 640, 480);

                // Создаем пустой AR-канвас
                arCanvas = document.createElement('canvas');
                arCanvas.width = photoCanvas.width;
                arCanvas.height = photoCanvas.height;
                arCanvas.getContext('2d').clearRect(0, 0, arCanvas.width, arCanvas.height);
            }

            openChatShell(characterToUse, !activeCharacter); // передаем флаг, что это рандомный выбор
            addCharacterMessage('Делаю твоё фото... ⏳');

            // ▼ сбросим состояние прямо здесь
            processedImage = null;
            photoWaitNoticeShown = false;
            processingDone = false;
            processingError = false;

            // Уменьшить громкость AR-аудио при начале съемки
            if (currentArAudio) {
              currentArAudio.volume = 0.2;
            }

            setTimeout(() => startScriptedDialog(characterToUse), 300);

            // Отправляем фото на сервер в любом случае (с AR-целью или без)
            // Если нет AR-цели, отправляем просто фото без AR-слоя
            await sendToServerWithRetries(photoCanvas, arCanvas, characterToUse, 3);
          }

        async function canvasToBlob(canvas) {
            return new Promise(res => canvas.toBlob(res, 'image/png'));
        }

        async function sendToServerWithRetries(photoCanvas, arCanvas, targetId, attempts = 3) {
          try {
            const [photoBlob, arBlob] = await Promise.all([
              canvasToBlob(photoCanvas),
              canvasToBlob(arCanvas)
            ]);

            for (let tryNo = 1; tryNo <= attempts; tryNo++) {
              const ok = await trySend(photoBlob, arBlob, targetId, tryNo);
              if (ok) {
                processingDone = true;
                processingError = false;
                return true;
              }
            }

            // все попытки исчерпаны — но НИЧЕГО не говорим в чат сейчас
            processingDone = true;
            processingError = true;
            return false;
          } catch (err) {
            console.error(err);
            processingDone = true;
            processingError = true;
            return false;
          }
        }

        async function trySend(photoBlob, arBlob, targetId, tryNo) {
          try {
            const formData = new FormData();
            formData.append('photo', photoBlob, 'photo.png');
            formData.append('ar_overlay', arBlob, 'ar_overlay.png');
            formData.append('active_target', targetId);

            const response = await fetch('/remove', { method: 'POST', body: formData });
            if (!response.ok) throw new Error('Ошибка сервера');

            const resultBlob = await response.blob();
            processedImage = URL.createObjectURL(resultBlob);
            questState[targetId].photo = processedImage;
            return true;
          } catch (error) {
            console.warn(`Попытка ${tryNo} не удалась`, error);
            // ⚠️ Не пишем ничего в чат, просто возвращаем false
            return false;
          }
        }

        function addCharacterMessage(text, audioSrc) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message character';
            msgDiv.innerHTML = `
                <div class="message-bubble">
                    <div class="message-text">${text}</div>
                </div>
            `;

            if (audioSrc) {
                // Остановить текущее воспроизводимое аудио персонажа (но не AR-музыку)
                if (currentlyPlayingAudio) {
                    currentlyPlayingAudio.pause();
                    currentlyPlayingAudio.currentTime = 0;
                }
                
                const audio = document.createElement('audio');
                audio.controls = true;
                const cached = audioCache.get(audioSrc) || audioSrc;
                audio.src = cached;
                msgDiv.querySelector('.message-bubble').appendChild(audio);
                
                // Установить текущее аудио персонажа как воспроизводимое
                currentlyPlayingAudio = audio;
                
                setTimeout(() => {
                    audio.play().catch(e => console.log('Audio failed'));
                }, 100);
            }

            document.getElementById('chat-container').appendChild(msgDiv);
            scrollChat();
        }

        function addUserMessage(text) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message user';
            msgDiv.innerHTML = `
                <div class="message-bubble">
                    <div class="message-text">${text}</div>
                </div>
            `;
            document.getElementById('chat-container').appendChild(msgDiv);
            scrollChat();
            
            // При добавлении пользовательского сообщения убедимся, что оно не вызывает конфликтов с аудио
            // Оставляем предыдущее аудио воспроизводимым, если оно уже воспроизводится
        }

        function showResponseButton(text, onClick) {
          const controls = document.getElementById('chat-controls');
          controls.innerHTML = `
            <div class="user-response-buttons">
              <button class="response-btn" id="resp-btn">${text}</button>
            </div>
          `;
          const btn = document.getElementById('resp-btn');
          btn.onclick = () => {
            addUserMessage(text);
            controls.innerHTML = '';
            if (typeof onClick === 'function') {
              // Добавить задержку в полсекунды перед выполнением следующего действия
              setTimeout(() => {
                onClick();
              }, 500);
            }
          };
        }

        function showProcessedPhoto(character) {
          // 1) Фото готово — показываем как раньше
          if (processedImage) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message character';
            msgDiv.innerHTML = `
              <div class="message-bubble">
                <div class="message-text">Вот твоё фото! 📸</div>
                <img src="${processedImage}" class="message-image" onclick="openImageViewer('${processedImage}')">
              </div>
            `;
            document.getElementById('chat-container').appendChild(msgDiv);
            scrollChat();
            setTimeout(() => showFinalButtons(character), 800);
            return;
          }

          // 2) Обработка ещё идёт — мягко подождём (сообщение только один раз)
          if (!processingDone) {
            if (!photoWaitNoticeShown) {
              addCharacterMessage('Одну секунду, фото почти готово... ⏳');
              photoWaitNoticeShown = true;
            }
            setTimeout(() => showProcessedPhoto(character), 1500);
            return;
          }

          // 3) Обработка завершилась, но фото нет → единое финальное сообщение вместо фото
          if (processingError) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message character';
            let errorMessage = 'Похоже, что-то пошло не так при обработке фото 😔';
            
            // Если это был не рандомный выбор (т.е. был выбран персонаж), добавляем сообщение о засчитанном задании
            if (!isRandomCharacter) {
                errorMessage += '<br>Но ты всё равно отлично справился — задание засчитано!';
            }
            
            msgDiv.innerHTML = `
              <div class="message-bubble">
                <div class="message-text">${errorMessage}</div>
              </div>
            `;
            document.getElementById('chat-container').appendChild(msgDiv);
            scrollChat();
            setTimeout(() => showFinalButtons(character), 800);
            return;
          }
          
          // 4) Если это рандомный выбор (без AR-цели), просто показываем финальные кнопки
          // Но только если не было ошибки обработки
          if (isRandomCharacter && !processingError) {
            setTimeout(() => showFinalButtons(character), 800);
            return;
          }
        }

        function showFinalButtons(character) {
            const controls = document.getElementById('chat-controls');
            if (isRandomCharacter) {
                // Для случайного выбора показываем кнопку "Назад" вместо "Продолжить квест"
                controls.innerHTML = `
                    <div class="user-response-buttons">
                        <button class="response-btn" onclick="continueToAI('${character}')">💬 Пообщаться дальше</button>
                        <button class="response-btn secondary" onclick="goBack()">⬅️ Назад</button>
                    </div>
                `;
            } else {
                // Для обычного выбора (с AR-целью) показываем как раньше
                controls.innerHTML = `
                    <div class="user-response-buttons">
                        <button class="response-btn" onclick="continueToAI('${character}')">💬 Пообщаться дальше</button>
                        <button class="response-btn secondary" onclick="continueQuest('${character}')">➡️ Продолжить квест</button>
                    </div>
                `;
            }
        }

        function continueToAI(character) {
          // ✅ Засчитать персонажа как выполненного, даже если пользователь выбрал «говорить дальше»
          // Но только если это не случайный выбор персонажа
          if (!questState[character].completed && !isRandomCharacter) {
            questState[character].completed = true;

            const el = document.getElementById(`progress-${character}`);
            if (el) {
              el.classList.remove('locked');
              el.classList.add('completed');
              // Можно оставить .active, если маркер всё ещё трекается — это не мешает
              // el.classList.remove('active'); // <- раскомментируй, если хочешь убирать подсветку
            }

            // Проверим, не собраны ли уже все персонажи
            checkQuestCompletion();
          }

          // Открываем блок AI-чата, как и раньше
          document.getElementById('chat-controls').innerHTML = `
            <div class="ai-chat-controls">
              <button class="record-btn idle" id="ai-record-btn" onclick="toggleRecording()">🎤</button>
              <div class="chat-status" id="ai-chat-status">Нажми на микрофон для записи</div>
            </div>
          `;

          // Показать кнопку выхода только для AI-чата
          document.getElementById('exit-ai-btn').style.display = 'inline-block';
        }

        function continueQuest(character) {
            // Засчитать персонажа как выполненного, только если это не случайный выбор
            if (!isRandomCharacter) {
                questState[character].completed = true;
                document.getElementById(`progress-${character}`).classList.remove('active');
                document.getElementById(`progress-${character}`).classList.remove('locked');
                document.getElementById(`progress-${character}`).classList.add('completed');
                
                // Проверим, не собраны ли уже все персонажи
                checkQuestCompletion();
            }
            
            document.getElementById('exit-ai-btn').style.display = 'none';
            document.getElementById('chat-modal').classList.remove('active');
            currentChatCharacter = null;
            processedImage = null;
            photoWaitNoticeShown = false;
            isRandomCharacter = false; // Сбросить флаг рандомного выбора
            isChatOpen = false; // Сбросить состояние чата
            
            // Вернуть громкость AR-музыки в зависимости от состояния чата
            if (currentArAudio) {
                currentArAudio.volume = isChatOpen ? 0.2 : 1.0;
            }
        }

        function checkQuestCompletion() {
            const allCompleted = Object.values(questState).every(s => s.completed);
            if (allCompleted) {
                setTimeout(() => {
                    document.getElementById('final-modal').classList.add('active');
                }, 800);
            }
        }

        function openCharacterFromProgress(character) {
            if (!questState[character].completed) return;

            // Показываем кнопку выхода, как у AI-чата после диалога
            document.getElementById('exit-ai-btn').style.display = 'inline-block';

            openChatShell(character);
            addCharacterMessage('С возвращением! Хочешь ещё поболтать? 😊');
            
            document.getElementById('chat-controls').innerHTML = `
                <div class="ai-chat-controls">
                    <button class="record-btn idle" id="ai-record-btn" onclick="toggleRecording()">🎤</button>
                    <div class="chat-status" id="ai-chat-status">Нажми на микрофон для записи</div>
                </div>
            `;
        }

        let mediaRecorder, audioChunks = [], isRecording = false, isProcessing = false;

        async function toggleRecording() {
            if (isProcessing) return;
            
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    stream.getTracks().forEach(track => track.stop());
                    sendAudioToAI(new Blob(audioChunks, { type: 'audio/webm' }));
                };
                
                mediaRecorder.start();
                isRecording = true;
                
                const btn = document.getElementById('ai-record-btn');
                btn.className = 'record-btn recording';
                btn.textContent = '⏹️';
                document.getElementById('ai-chat-status').textContent = '🎙️ Запись...';
            } catch (error) {
                console.error('Ошибка доступа к микрофону:', error);
                document.getElementById('ai-chat-status').textContent = '❌ Нет доступа к микрофону';
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                isRecording = false;
            }
        }

        async function sendAudioToAI(audioBlob) {
            isProcessing = true;
            const btn = document.getElementById('ai-record-btn');
            btn.className = 'record-btn processing';
            btn.textContent = '⏳';
            document.getElementById('ai-chat-status').textContent = '🔄 Обработка...';
            
            try {
                const formData = new FormData();
                formData.append('audio', audioBlob, 'voice.webm');
                formData.append('character', currentChatCharacter);
                formData.append('device_id', SESSION_ID);

                const response = await fetch('/api/chat-stream', { method: 'POST', body: formData });
                if (!response.ok) throw new Error('Ошибка сервера');

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        if (!line.trim()) continue;
                        const data = JSON.parse(line);

                        if (data.type === 'stt') {
                            addUserMessage(data.user_text);
                            // Show typing indicator after user message is added
                            showAITypingIndicator();
                        } else if (data.type === 'final') {
                            // Remove typing indicator when character response arrives
                            hideAITypingIndicator();
                            const audioUrl = URL.createObjectURL(base64ToBlob(data.audio_base64, 'audio/mpeg'));
                            addCharacterMessage(data.reply_text, audioUrl);
                            document.getElementById('ai-chat-status').textContent = '✅ Готово! Нажми снова';
                        } else if (data.type === 'error') {
                            // Remove typing indicator if there's an error
                            hideAITypingIndicator();
                            addCharacterMessage('Извини, что-то пошло не так... 😢');
                            document.getElementById('ai-chat-status').textContent = '❌ Ошибка';
                        }
                    }
                }
            } catch (error) {
                console.error('Ошибка:', error);
                // Remove typing indicator if there's an error
                hideAITypingIndicator();
                addCharacterMessage('Извини, что-то пошло не так... 😢');
                document.getElementById('ai-chat-status').textContent = '❌ Ошибка';
            } finally {
                isProcessing = false;
                btn.className = 'record-btn idle';
                btn.textContent = '🎤';
            }
        }

        function base64ToBlob(base64, mimeType) {
            const byteCharacters = atob(base64);
            const byteArrays = [];
            for (let offset = 0; offset < byteCharacters.length; offset += 512) {
                const slice = byteCharacters.slice(offset, offset + 512);
                const byteNumbers = new Array(slice.length);
                for (let i = 0; i < slice.length; i++) byteNumbers[i] = slice.charCodeAt(i);
                byteArrays.push(new Uint8Array(byteNumbers));
            }
            return new Blob(byteArrays, { type: mimeType });
        }

        function openImageViewer(imageSrc) {
            document.getElementById('viewer-image').src = imageSrc;
            document.getElementById('image-viewer').classList.add('active');
        }

        function closeImageViewer() {
            document.getElementById('image-viewer').classList.remove('active');
        }

        function downloadImage() {
            const link = document.createElement('a');
            link.download = `ar-photo-${Date.now()}.png`;
            link.href = document.getElementById('viewer-image').src;
            link.click();
        }

        function scrollChat() {
            const container = document.getElementById('chat-container');
            container.scrollTop = container.scrollHeight;
        }

        function showAITypingIndicator() {
            // Only show typing indicator in AI chat (not in photo chat)
            if (!currentChatCharacter) return;
            
            // Create typing indicator message
            aiTypingIndicator = document.createElement('div');
            aiTypingIndicator.className = 'message character';
            aiTypingIndicator.innerHTML = `
                <div class="message-bubble">
                    <div class="typing-indicator">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            document.getElementById('chat-container').appendChild(aiTypingIndicator);
            scrollChat();
        }

        function hideAITypingIndicator() {
            // Remove typing indicator if it exists
            if (aiTypingIndicator && aiTypingIndicator.parentNode) {
                aiTypingIndicator.parentNode.removeChild(aiTypingIndicator);
                aiTypingIndicator = null;
            }
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('active', show);
        }

        function buyTickets() {
            window.open('https://souzmultpark.ru/?promo=promo1', '_blank');
        }

        function goBack() {
            // Скрыть кнопку выхода
            document.getElementById('exit-ai-btn').style.display = 'none';

            // Закрыть модалку
            document.getElementById('chat-modal').classList.remove('active');

            // Сбросить состояние
            currentChatCharacter = null;
            processedImage = null;
            photoWaitNoticeShown = false;
            isRandomCharacter = false; // Сбросить флаг рандомного выбора
            isRecording = false;
            isProcessing = false;
            isChatOpen = false; // Сбросить состояние чата

            // Вернуть громкость AR-музыки
            if (currentArAudio) {
                currentArAudio.volume = 1.0;
            }
        }

        function exitAIChat() {
            // Скрыть кнопку
            document.getElementById('exit-ai-btn').style.display = 'none';

            // Закрыть модалку
            document.getElementById('chat-modal').classList.remove('active');

            // Сбросить состояние
            currentChatCharacter = null;
            processedImage = null;
            photoWaitNoticeShown = false;
            isRandomCharacter = false; // Сбросить флаг рандомного выбора
            isRecording = false;
            isProcessing = false;
            isChatOpen = false; // Сбросить состояние чата

            // Вернуть громкость AR-музыки
            if (currentArAudio) {
                currentArAudio.volume = 1.0;
            }
        }

        window.addEventListener('beforeunload', () => {
          for (const url of audioCache.values()) URL.revokeObjectURL(url);
        });
    </script>
</body>
</html>