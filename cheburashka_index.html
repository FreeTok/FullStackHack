<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ò–ò –ß–µ–±—É—Ä–∞—à–∫–∞</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Comic Sans MS", sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
      background: linear-gradient(135deg, #f7f4e9 0%, #ffd89b 100%);
    }

    .container {
      max-width: 500px;
      width: 100%;
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }

    h1 {
      color: #ff8c42;
      text-align: center;
      margin-bottom: 30px;
      font-size: 32px;
    }

    .chat-container {
      max-height: 400px;
      overflow-y: auto;
      margin-bottom: 20px;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 15px;
    }

    .message {
      margin-bottom: 15px;
      padding: 12px 16px;
      border-radius: 15px;
      max-width: 80%;
      word-wrap: break-word;
    }

    .message.user {
      background: #e3f2fd;
      margin-left: auto;
      text-align: right;
    }

    .message.cheburashka {
      background: #fff3cd;
      margin-right: auto;
    }

    .message .label {
      font-weight: bold;
      font-size: 12px;
      margin-bottom: 5px;
      opacity: 0.7;
    }

    .message .text {
      font-size: 15px;
      line-height: 1.4;
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 15px;
      align-items: center;
    }

    .record-btn {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: none;
      font-size: 36px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .record-btn.idle {
      background: #ffb347;
    }

    .record-btn.idle:hover {
      background: #ff9947;
      transform: scale(1.05);
    }

    .record-btn.recording {
      background: #ff4757;
      animation: pulse 1.5s infinite;
    }

    .record-btn.processing {
      background: #888;
      cursor: not-allowed;
      animation: spin 2s linear infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    #status {
      font-size: 16px;
      color: #666;
      text-align: center;
      min-height: 24px;
    }

    .timer {
      font-size: 18px;
      font-weight: bold;
      color: #ff4757;
    }

    audio {
      width: 100%;
      margin-top: 10px;
      border-radius: 10px;
    }

    .audio-player {
      display: none;
      margin-top: 10px;
    }

    .audio-player.visible {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üê≠ –ß–µ–±—É—Ä–∞—à–∫–∞ AI</h1>
    
    <div class="chat-container" id="chatContainer">
      <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å -->
    </div>

    <div class="controls">
      <button class="record-btn idle" id="recordBtn">üé§</button>
      <div id="status">–ù–∞–∂–º–∏ –Ω–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω</div>
    </div>
  </div>

  <script>
    const recordBtn = document.getElementById('recordBtn');
    const statusEl = document.getElementById('status');
    const chatContainer = document.getElementById('chatContainer');

    let mediaRecorder;
    let audioChunks = [];
    let recordingStartTime;
    let timerInterval;
    let isProcessing = false;

    // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
    function addMessage(text, type, audioSrc = null) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      
      const label = document.createElement('div');
      label.className = 'label';
      label.textContent = type === 'user' ? '–í—ã' : '–ß–µ–±—É—Ä–∞—à–∫–∞';
      
      const textDiv = document.createElement('div');
      textDiv.className = 'text';
      textDiv.textContent = text;
      
      messageDiv.appendChild(label);
      messageDiv.appendChild(textDiv);
      
      if (audioSrc && type === 'cheburashka') {
        const audio = document.createElement('audio');
        audio.controls = true;
        audio.src = audioSrc;
        audio.style.marginTop = '10px';
        messageDiv.appendChild(audio);
        
        // –ê–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
        setTimeout(() => audio.play(), 100);
      }
      
      chatContainer.appendChild(messageDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞ –∑–∞–ø–∏—Å–∏
    function updateTimer() {
      const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
      const minutes = Math.floor(elapsed / 60);
      const seconds = elapsed % 60;
      statusEl.innerHTML = `<span class="timer">‚è∫Ô∏è ${minutes}:${seconds.toString().padStart(2, '0')}</span>`;
    }

    // –ù–∞—á–∞–ª–æ –∑–∞–ø–∏—Å–∏
    async function startRecording() {
      if (isProcessing) return;

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
        audioChunks = [];

        mediaRecorder.ondataavailable = (event) => {
          audioChunks.push(event.data);
        };

        mediaRecorder.onstop = async () => {
          clearInterval(timerInterval);
          stream.getTracks().forEach(track => track.stop());
          
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          await sendAudioToServer(audioBlob);
        };

        mediaRecorder.start();
        recordingStartTime = Date.now();
        
        recordBtn.className = 'record-btn recording';
        recordBtn.textContent = '‚èπÔ∏è';
        
        timerInterval = setInterval(updateTimer, 1000);
        updateTimer();
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:', error);
        statusEl.textContent = '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É';
      }
    }

    // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–ø–∏—Å–∏
    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
      }
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –∞—É–¥–∏–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    async function sendAudioToServer(audioBlob) {
      isProcessing = true;
      recordBtn.className = 'record-btn processing';
      recordBtn.textContent = '‚è≥';
      statusEl.textContent = 'üîÑ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é...';

      try {
        const formData = new FormData();
        formData.append('audio', audioBlob, 'voice.webm');

        const response = await fetch('/api/chat-stream', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
        }

        const data = await response.json();
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        addMessage(data.user_text, 'user');
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –ß–µ–±—É—Ä–∞—à–∫–∏
        const responseAudioBlob = base64ToBlob(data.audio_base64, 'audio/ogg');
        const audioUrl = URL.createObjectURL(responseAudioBlob);
        addMessage(data.reply_text, 'cheburashka', audioUrl);
        
        statusEl.textContent = '‚úÖ –ì–æ—Ç–æ–≤–æ! –ù–∞–∂–º–∏ —Å–Ω–æ–≤–∞';
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        statusEl.textContent = '‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏';
        addMessage('–ò–∑–≤–∏–Ω–∏, —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫... üò¢', 'cheburashka');
      } finally {
        isProcessing = false;
        recordBtn.className = 'record-btn idle';
        recordBtn.textContent = 'üé§';
      }
    }

    // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è base64 –≤ Blob
    function base64ToBlob(base64, mimeType) {
      const byteCharacters = atob(base64);
      const byteArrays = [];
      
      for (let offset = 0; offset < byteCharacters.length; offset += 512) {
        const slice = byteCharacters.slice(offset, offset + 512);
        const byteNumbers = new Array(slice.length);
        
        for (let i = 0; i < slice.length; i++) {
          byteNumbers[i] = slice.charCodeAt(i);
        }
        
        const byteArray = new Uint8Array(byteNumbers);
        byteArrays.push(byteArray);
      }
      
      return new Blob(byteArrays, { type: mimeType });
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫—É
    recordBtn.addEventListener('click', () => {
      if (isProcessing) return;
      
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        stopRecording();
      } else {
        startRecording();
      }
    });

    // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    addMessage('–ü—Ä–∏–≤–µ—Ç! –ù–∞–∂–º–∏ –Ω–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω –∏ —Ä–∞—Å—Å–∫–∞–∂–∏ –º–Ω–µ —á—Ç–æ-–Ω–∏–±—É–¥—å! üëÇ', 'cheburashka');
  </script>
</body>
</html>